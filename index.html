<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í’ë¬´ê³ ë“±í•™êµ ìˆ˜ì‹œ ì…ì‹œ ê²°ê³¼ í†µê³„í”„ë¡œê·¸ë¨</title>

  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <style>
    :root {
      --bg: #f6f4ef;
      --card: #ffffff;
      --border: #d9d2c3;
      --primary: #6b8f71;
      --primary-dark: #58765e;
      --accent: #d07a5c;
      --text: #2f3c32;
      --muted: #6a7065;
      --shadow: 0 10px 28px rgba(47,60,50,0.12);
      --stickyTop: 190px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans KR", "Pretendard", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* âœ… ì¶”ê°€: í‘œ/ë¹ˆë°ì´í„° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .stats-table th, .stats-table td {
      border: 1px solid #e4ddcf;
      padding: 7px;
      text-align: center;
    }
    .stats-table thead th {
      background: #f1ede5;
      font-weight: 800;
    }
    .empty {
      padding: 18px;
      border: 1px dashed #d9d2c3;
      border-radius: 12px;
      color: var(--muted);
      text-align: center;
      background: #fff;
    }

    /* ===== ìƒë‹¨ ===== */
    .hero {
      padding: 28px 20px 14px;
      text-align: center;
    }

    .panel {
      max-width: 1160px;
      margin: 0 auto 18px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #eef0eb;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
    }

    button.primary {
      background: var(--primary);
      color: #fff;
    }

    /* ===== ê³ ì • í—¤ë” ===== */
    .fixed-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.95);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .grade-toggle-btn.active {
      background: var(--accent);
      color: #fff;
    }

    /* ===== ë ˆì´ì•„ì›ƒ ===== */
    .layout {
      max-width: 1200px;
      margin: 0 auto 32px;
      display: flex;
      gap: 16px;
      padding: 0 12px;
      align-items: flex-start;
    }

    .toc-container {
      flex: 0 0 220px;
      position: sticky;
      top: var(--stickyTop);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .main-content {
      flex: 1;
      padding: 0;
    }

    .dept-container {
      margin-bottom: 28px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      background: #fff;
      box-shadow: var(--shadow);
    }

    .dept-header {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 14px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
    }

    .print-grade-line {
      font-weight: 800;
      margin-bottom: 6px;
    }

    /* ===== ì¸ì‡„ ===== */
    @media print {
      @page { size: A4 portrait; margin: 12mm; }

      body { background: #fff !important; }

      .hero, .panel, .fixed-header, .toc-container {
        display: none !important;
      }

      .layout {
        display: block !important;
        padding: 0 !important;
      }

      .dept-container {
        page-break-before: always;
        break-before: page;
        box-shadow: none;
        border: none;
      }
body.print-overall #report .dept-container:not(#overall-summary) { display:none !important; }
body.print-capital #report .dept-container:not(#capital-summary) { display:none !important; }
body.print-special #report .dept-container:not(#special-summary) { display:none !important; }

      body.print-overall #overall-summary,
body.print-capital #capital-summary,
body.print-special #special-summary {
  page-break-before: auto !important;
  break-before: auto !important;
}

      /* âœ… ì²« ë¸”ë¡ì€ ê°•ì œ í˜ì´ì§€ ë¸Œë ˆì´í¬ ì œê±° */
      #overall-summary {
        page-break-before: auto !important;
        break-before: auto !important;
      }

      .plot-container {
        height: 320px !important;
      }
    }
    /* âœ… íŒŒì¼ì„ íƒ(input) + ë²„íŠ¼(actions) í•œ ì¤„ ê³ ì • */
.panel .field{
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: nowrap;      /* ë°ìŠ¤í¬í†±ì—ì„œ 2ì¤„ ë°©ì§€ */
}

/* âœ… file inputì´ ë²„íŠ¼ì„ ë°€ì–´ë‚´ì§€ ì•Šê²Œ í­ ì œí•œ */
.panel .field #file-input{
  flex: 1 1 auto;         /* ë‚¨ëŠ” ê³µê°„ì€ ë¨¹ë˜ */
  min-width: 260px;
  max-width: 520px;       /* ë„ˆë¬´ ì»¤ì ¸ì„œ ë²„íŠ¼ì„ ì•„ë˜ë¡œ ë°€ì§€ ì•Šê²Œ */
}

/* âœ… ë²„íŠ¼ë“¤ë„ í•œ ì¤„ ê³ ì • */
.panel .field .actions{
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;      /* ë²„íŠ¼ 2ê°œê°€ ì¤„ë°”ê¿ˆ ì•ˆ ë˜ê²Œ */
  flex: 0 0 auto;
}

/* âœ… í™”ë©´ì´ ì¢ì„ ë•Œë§Œ ì¤„ë°”ê¿ˆ í—ˆìš©(ëª¨ë°”ì¼/ì‘ì€ ì°½ ëŒ€ì‘) */
@media (max-width: 560px){
  .panel .field{ flex-wrap: wrap; }
  .panel .field #file-input{ max-width: 100%; }
  .panel .field .actions{ width: 100%; }
}
/* âœ… ê³ ì •í—¤ë” ì•„ë˜ ì½˜í…ì¸ ê°€ ë„ˆë¬´ ë‹¬ë¼ë¶™ì§€ ì•Šê²Œ */
.layout{
  margin-top: 14px;
}
/* âœ… ê³ ì •í—¤ë” 'í° ë ' ëŠë‚Œ ì¤„ì´ê³ , ë‚´ìš©ë§Œ ì¹´ë“œì²˜ëŸ¼ ë³´ì´ê²Œ */
.fixed-header{
  background: transparent;      /* ì „ì²´ í­ í° ë°°ê²½ ì œê±° */
  border-bottom: none;
  box-shadow: none;
  padding: 10px 0;
}

.header-content{
  background: rgba(255,255,255,0.96);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: var(--shadow);
}
/* =========================
   âœ… ê³ ì •í—¤ë” ìœ ì§€ + ì•„ë˜ ì½˜í…ì¸  'ë‹¬ë¼ë¶™ìŒ' í•´ê²° íŒ¨ì¹˜
   (style ë§¨ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°)
   ========================= */

/* 1) ê³ ì •í—¤ë”ê°€ í™”ë©´ ì „ì²´ë¥¼ 'í° ë 'ë¡œ ë®ëŠ” ëŠë‚Œ ì¤„ì´ê¸°
      -> ë°”ê¹¥ì€ íˆ¬ëª…, ì•ˆìª½ë§Œ ì¹´ë“œ */
.fixed-header{
  background: transparent;
  border-bottom: none;
  box-shadow: none;
  padding: 10px 0;
}

/* ê³ ì •í—¤ë” ë‚´ë¶€ë¥¼ ì¹´ë“œì²˜ëŸ¼ */
.header-content{
  background: rgba(255,255,255,0.96);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: var(--shadow);
}

/* 2) ê³ ì •í—¤ë” ì•„ë˜ ì²« ì½˜í…ì¸ (ëª©ì°¨/ì¶œë ¥ê¸°ì¤€)ê°€ ë‹¬ë¼ë¶™ì§€ ì•Šë„ë¡ ê°„ê²© í™•ë³´ */
.layout{
  margin-top: 14px;
}

/* 3) ê³ ì •í—¤ë”ê°€ ì‚´ì§ ë– ë³´ì´ê²Œ(ìƒë‹¨ ì—¬ë°±) + ìŠ¤í¬ë¡¤ ì‹œ ì‹œê°ì  ë¶„ë¦¬ */
.fixed-header::after{
  content:"";
  display:block;
  height: 8px;
}
/* =========================
   âœ… ê³ ì •í—¤ë” ë‚´ë¶€(ì œëª©/í† ê¸€/ë²”ë¡€) ì •ëˆ
   ========================= */

/* modified by KO: ì‘ê²Œ/ì—°í•˜ê²Œ/ì •ë ¬ */
.site-title{
  font-size: 12px;
  color: var(--muted);
  font-weight: 600;
  letter-spacing: 0.2px;
}

/* í—¤ë” ë‚´ë¶€ íƒ€ì´í‹€ ê°„ê²© */
.university-title{
  margin: 4px 0 2px;
  font-size: 20px;
  font-weight: 900;
}

/* í† ê¸€/ë²”ë¡€ ë˜í¼: ì¤„ë°”ê¿ˆí•´ë„ ê°„ê²© ìœ ì§€ */
.controls-legend-wrapper{
  gap: 10px !important;
}

/* í† ê¸€ ë²„íŠ¼: í­/ê°„ê²© í†µì¼ */
.grade-toggle-container{
  display: inline-flex;
  gap: 8px;
  align-items: center;
}
.grade-toggle-btn{
  min-width: 120px;
}

/* ë²”ë¡€ ë°•ìŠ¤: ì•ˆìª½ ê°„ê²© + ì¤„ë°”ê¿ˆ ì‹œ ë³´ê¸° ì¢‹ê²Œ */
.legend-container{
  line-height: 1.35;
}
.legend-items-wrapper{
  row-gap: 6px !important;
}

/* (ì„ íƒ) ì‘ì€ í™”ë©´ì—ì„œ í† ê¸€/ë²”ë¡€ê°€ ë„ˆë¬´ íƒ€ì´íŠ¸í•˜ë©´ ìë™ ì¤„ë°”ê¿ˆ */
@media (max-width: 900px){
  .grade-toggle-btn{ min-width: 110px; }
}
/* =========================
   âœ… ëª©ì°¨/ì¶œë ¥ê¸°ì¤€ 'ë‹¬ë¼ë¶™ìŒ' ê°œì„ 
   ========================= */

/* ê³ ì •í—¤ë” ë°‘ ì‹œì‘ ì—¬ë°± */
.layout{
  margin-top: 18px;
}

/* ëª©ì°¨ ë°•ìŠ¤ ìì²´ë„ ì‚´ì§ ì•„ë˜ë¡œ ì—¬ìœ  */
.toc-container{
  padding-top: 16px;
}

/* ë³¸ë¬¸ ì²« ë²ˆì§¸ ìš”ì•½ ë°•ìŠ¤(ì¶œë ¥ ê¸°ì¤€)ê°€ ìœ„ì— ë„ˆë¬´ ë¶™ì§€ ì•Šê²Œ */
#content-area > .dept-container:first-child{
  margin-top: 10px;
}
/* ===== ì¶œë ¥ ëª¨ë“œ ë¶„ê¸° ===== */
/* ê¸°ë³¸(ì „ì²´ ì¶œë ¥): ì œí•œ ì—†ìŒ */

@media print {
  /* ì „ì²´ ì¶œë ¥ì€ ê·¸ëŒ€ë¡œ */

  /* í˜„í™© 1ë¶€: overall-summaryë§Œ ì¶œë ¥ */
  body.print-overall #report .dept-container:not(#overall-summary) {
    display: none !important;
  }

  /* ì„œìš¸+ìˆ˜ë„ê¶Œ ì¶œë ¥: capital-summaryë§Œ ì¶œë ¥ */
  body.print-capital #report .dept-container:not(#capital-summary) {
    display: none !important;
  }

  /* íŠ¹ì • ì„¹ì…˜ì€ í˜ì´ì§€ ë¸Œë ˆì´í¬ ìµœì†Œí™” */
  body.print-overall #overall-summary,
  body.print-capital #capital-summary {
    page-break-before: auto !important;
    break-before: auto !important;
  }
}

    
  </style>
</head>

<body>
  <header class="hero">
    <h1>ìˆ˜ì‹œ ì…ì‹œ ê²°ê³¼ í†µê³„ í”„ë¡œê·¸ë¨ [í’ë¬´ê³ ë“±í•™êµ]</h1>
    <p>ëŒ€êµí˜‘ìƒë‹´í”„ë¡œê·¸ë¨ - ì§„í•™ê´€ë¦¬ - ìˆ˜ì‹œì§„í•™ê´€ë¦¬ì˜ ì—‘ì…€íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>
  </header>

  <section class="panel">
    <h2>ì—‘ì…€ ì—…ë¡œë“œ</h2>
    <div class="field">
      <input type="file" id="file-input" accept=".xlsx,.xls" />
    <div class="actions">
  <button class="primary" id="generate-btn">ë³´ê³ ì„œ ìƒì„±</button>

  <button id="print-overall-btn">ğŸ–¨ï¸ í˜„í™© ì¶œë ¥(1ë¶€)</button>
  <button id="print-capital-btn">ğŸ–¨ï¸ ì„œìš¸+ìˆ˜ë„ê¶Œ ì¶œë ¥</button>
  <button id="print-full-btn">ğŸ–¨ï¸ ì „ì²´ ì¶œë ¥</button>
</div>

    </div>
    <div id="status"></div>
  </section>

  <section id="report" hidden></section>

  <script>
    const RESULT_ORDER = ["í•©ê²©", "ì¶©ì›í•©ê²©", "ë¶ˆí•©ê²©"];
    const COLOR_MAP = {
      "í•©ê²©":   { border: "#5f8669", fill: "rgba(95, 134, 105, 0.30)" },
      "ì¶©ì›í•©ê²©": { border: "#7cab7c", fill: "rgba(124, 171, 124, 0.28)" },
      "ë¶ˆí•©ê²©": { border: "#d07a5c", fill: "rgba(208, 122, 92, 0.32)" },
    };
    const SYMBOL_MAP = { "í•©ê²©": "circle", "ì¶©ì›í•©ê²©": "triangle-up", "ë¶ˆí•©ê²©": "x" };
    const Y_POS = { "í•©ê²©": 0.01, "ì¶©ì›í•©ê²©": 0.0, "ë¶ˆí•©ê²©": -0.03 };
    const BINS = { start: 1, end: 9, size: 0.5 };

    const fileInput = document.getElementById("file-input");
    const statusEl  = document.getElementById("status");
    const reportEl  = document.getElementById("report");
    const generateBtn = document.getElementById("generate-btn");

    let currentGradeType = "all_subj";
    let plotsData = {};
    let plotInitialized = {};
    let lastRecords = null;

    generateBtn.addEventListener("click", handleGenerate);

    // âœ… ì¸ì‡„ ë²„íŠ¼(3ì¢…) ì´ë²¤íŠ¸
document.getElementById("print-overall-btn").addEventListener("click", () => printWithMode("overall"));
document.getElementById("print-capital-btn").addEventListener("click", () => printWithMode("capital"));
document.getElementById("print-full-btn").addEventListener("click", () => printWithMode("full"));

  <button class="primary" id="generate-btn">ë³´ê³ ì„œ ìƒì„±</button>
  <button id="print-overall-btn">ğŸ–¨ï¸ í˜„í™© ì¶œë ¥(1ë¶€)</button>
  <button id="print-capital-btn">ğŸ–¨ï¸ ì„œìš¸+ìˆ˜ë„ê¶Œ ì¶œë ¥</button>
  <button id="print-full-btn">ğŸ–¨ï¸ ì „ì²´ ì¶œë ¥</button>
</div>


    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#c0392b" : "#607089";
    }

    async function handleGenerate() {
      const file = fileInput.files[0];
      if (!file) {
        setStatus("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", true);
        return;
      }
      setStatus("ì—‘ì…€ì„ ì½ëŠ” ì¤‘...");

      try {
        const records = await parseExcel(file);
        if (!records.length) {
          setStatus("ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„ìˆ˜ ì»¬ëŸ¼ì„ í™•ì¸í•˜ì„¸ìš”.", true);
          return;
        }
        lastRecords = records;
        renderFullReport(records);
        setStatus(`ì´ ${records.length}ê±´ ë¡œë“œ ì™„ë£Œ. ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } catch (e) {
        console.error(e);
        setStatus("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + e.message, true);
      }
    }

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];

            // ì²« 2í–‰ ìŠ¤í‚µ(ì‚¬ìš©ì ì›ë³¸ ë¡œì§ ìœ ì§€)
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 2 });

            // í˜•ì‹ íŒë³„(ì‚¬ìš©ì ì›ë³¸ ë¡œì§ ìœ ì§€)
            const isAltFormat = (() => {
              const cell = sheet["V1"];
              const val = cell ? String(cell.v || "").trim() : "";
              return val.includes("ìµœì¢…ë‹¨ê³„");
            })();

            // ê¸°ë³¸: result=R(17), all_subj=AG(32), conv=AH(33)
            // ëŒ€ì•ˆ: result=V(21), all_subj=R(17), conv=T(19)
            const COL = {
              region: 5,  // F
              univ: 6,    // G
              apptype: 8, // I
              subtype: 10,// K
              dept: 12,   // M
              result: isAltFormat ? 21 : 17,
              all:    isAltFormat ? 17 : 32,
              conv:   isAltFormat ? 19 : 33,
            };

            const records = [];
            rows.forEach((row) => {
              const rec = {
                grade: safe(row[0]),          // A: í•™ë…„
                class_no: safe(row[1]),       // B: ë°˜
                student_no: safe(row[2]),     // C: ë²ˆí˜¸
                student_name: safe(row[3]),   // D: ì´ë¦„
                region: safe(row[COL.region]),
                univ: safe(row[COL.univ]),
                apptype: safe(row[COL.apptype]),
                subtype: safe(row[COL.subtype]),
                dept: safe(row[COL.dept]),
                result: safe(row[COL.result]),
                all_subj_grade: parseGrade(row[COL.all]),
                conv_grade: parseGrade(row[COL.conv]),
              };

              // í•„ìˆ˜ê°’ ì²´í¬
              if (!rec.result || !rec.univ || !rec.dept || !rec.subtype || !rec.apptype) return;
              if (rec.all_subj_grade === null && rec.conv_grade === null) return;

              records.push(rec);
            });

            resolve(records);
          } catch (err) {
            reject(err);
          }
        };

        reader.onerror = (err) => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    function safe(v) {
      return v === undefined || v === null ? "" : String(v).trim();
    }

    function parseGrade(v) {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : null;
    }

    function unique(arr) {
      return Array.from(new Set(arr)).filter(Boolean).sort();
    }
function printWithMode(mode) {
  if (reportEl.hidden) {
    alert("ë¨¼ì € ë³´ê³ ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!");
    return;
  }

  document.body.classList.remove("print-overall", "print-capital", "print-special");

  if (mode === "overall") document.body.classList.add("print-overall");
  if (mode === "capital") document.body.classList.add("print-capital");
  if (mode === "special") document.body.classList.add("print-special");

  window.print();

  document.body.classList.remove("print-overall", "print-capital", "print-special");
}

document.getElementById("print-overall-btn").addEventListener("click", () => printWithMode("overall"));
document.getElementById("print-capital-btn").addEventListener("click", () => printWithMode("capital"));
document.getElementById("print-full-btn").addEventListener("click", () => printWithMode("full"));

// ===== (A) ëŒ€í•™ëª… ì •ê·œí™” / ìº í¼ìŠ¤ íŒì • / ì§€ì—­ ë³´ì • =====

// 1) ìƒìœ„ê¶Œ(ì¼ë°˜) ëŒ€í•™ ê³ ì • ë¦¬ìŠ¤íŠ¸ (í•„ìš”ì‹œ ê³„ì† ì¶”ê°€)
const TOP_TIER_UNIVS = [
  "ì„œìš¸ëŒ€","ì—°ì„¸ëŒ€","ê³ ë ¤ëŒ€","ì„œê°•ëŒ€","ì„±ê· ê´€ëŒ€","í•œì–‘ëŒ€",
  "ì¤‘ì•™ëŒ€","ê²½í¬ëŒ€","í•œêµ­ì™¸ëŒ€","ì´í™”ì—¬ëŒ€",
  "ê±´êµ­ëŒ€","ë™êµ­ëŒ€","í™ìµëŒ€","ìˆ™ëª…ì—¬ëŒ€"
];

// 2) íŠ¹ìˆ˜ëª©ì ëŒ€í•™(íŠ¹ëª©ëŒ€) ê³ ì • ë¦¬ìŠ¤íŠ¸(í•„ìš”ì‹œ ì¶”ê°€/ìˆ˜ì •)
const SPECIAL_PURPOSE_UNIVS = [
  // ì´ê³µê³„ íŠ¹ì„±í™”
  "KAIST","GIST","DGIST","UNIST","KENTEC",
  // ì‚¬ê´€/íŠ¹ìˆ˜
  "ìœ¡ì‚¬","í•´ì‚¬","ê³µì‚¬","êµ­ê°„ì‚¬","ê²½ì°°ëŒ€"
];

// 3) ë¬¸ìì—´ ì •ê·œí™”(ê³µë°±/ëŒ€í•™/ëŒ€í•™êµ ë“± í”í•œ í”ë“¤ë¦¼ ì™„í™”)
function normalizeUnivName(raw) {
  if (!raw) return "";
  let s = String(raw).trim();

  // ê´„í˜¸ ì•ë’¤ ê³µë°± ì •ë¦¬
  s = s.replace(/\s*\(\s*/g, "(").replace(/\s*\)\s*/g, ")");

  // í”í•œ ì ‘ë¯¸ ì •ë¦¬(ì›í•˜ë©´ ë” ì¶”ê°€ ê°€ëŠ¥)
  s = s.replace(/ëŒ€í•™êµ/g, "").replace(/ëŒ€í•™$/g, "");

  return s;
}

// 4) "ê³ ë ¤ëŒ€(ì„¸ì¢…)" ê°™ì€ ìº í¼ìŠ¤ íƒœê·¸ ì¶”ì¶œ
function getCampusTag(univName) {
  const m = univName.match(/\(([^)]+)\)/);
  return m ? m[1].trim() : ""; // ì˜ˆ: "ì„¸ì¢…", "ì•ˆì•”", "ERICA", "ë¯¸ë˜", "ê¸€ë¡œì»¬"
}

// 5) ëŒ€í•™ëª… ê¸°ë°˜ ìˆ˜ë„ê¶Œ íŒì •(ì§€ì—­ê°’ì´ ë¹„ì–´ ìˆê±°ë‚˜, ìº í¼ìŠ¤ ì˜ˆì™¸ê°€ í•„ìš”í•œ ê²½ìš°)
function inferCapitalByUniv(univRaw) {
  const u = normalizeUnivName(univRaw);
  const campus = getCampusTag(u);

  // ----- ìº í¼ìŠ¤ ì˜ˆì™¸(ì¤‘ìš”) -----
  // ê³ ë ¤ëŒ€(ì„¸ì¢…) = ë¹„ìˆ˜ë„ê¶Œ(ì„¸ì¢…)
  if (u.includes("ê³ ë ¤ëŒ€") && campus.includes("ì„¸ì¢…")) return false;

  // ì—°ì„¸ëŒ€(ë¯¸ë˜) = ì›ì£¼(ê°•ì›) -> ë¹„ìˆ˜ë„ê¶Œ
  if (u.includes("ì—°ì„¸ëŒ€") && campus.includes("ë¯¸ë˜")) return false;

  // ê±´êµ­ëŒ€(ê¸€ë¡œì»¬) = ì¶©ì£¼ -> ë¹„ìˆ˜ë„ê¶Œ
  if (u.includes("ê±´êµ­ëŒ€") && campus.includes("ê¸€ë¡œì»¬")) return false;

  // ----- ìˆ˜ë„ê¶Œìœ¼ë¡œ ë³´ëŠ” ì¼€ì´ìŠ¤(ìº í¼ìŠ¤ í‘œê¸°ê°€ ìˆì–´ë„ ìˆ˜ë„ê¶Œì¼ ìˆ˜ ìˆìŒ) -----
  // í•œì–‘ëŒ€(ERICA) = ê²½ê¸°(ì•ˆì‚°) -> ìˆ˜ë„ê¶Œ
  if (u.includes("í•œì–‘ëŒ€") && campus.toUpperCase().includes("ERICA")) return true;

  // ----- ê¸°ë³¸ ëŒ€í•™ëª… ë§¤ì¹­(ìˆ˜ë„ê¶Œìœ¼ë¡œ ë³¼ ëŒ€í•™ë“¤) -----
  // ì—¬ê¸°ì„œ â€œì„œìš¸ê¶Œ/ìˆ˜ë„ê¶Œ ëŒ€í•™â€ì„ ë„“ê²Œ ì¡ì„ì§€, ì¢ê²Œ ì¡ì„ì§€ ë„¤ ê¸°ì¤€ëŒ€ë¡œ í™•ì¥ ê°€ëŠ¥
  const capitalByName = [
    "ì„œìš¸ëŒ€","ì—°ì„¸ëŒ€","ê³ ë ¤ëŒ€","ì„œê°•ëŒ€","ì„±ê· ê´€ëŒ€","í•œì–‘ëŒ€",
    "ì¤‘ì•™ëŒ€","ê²½í¬ëŒ€","í•œêµ­ì™¸ëŒ€","ì´í™”ì—¬ëŒ€","ê±´êµ­ëŒ€","ë™êµ­ëŒ€",
    "í™ìµëŒ€","ìˆ™ëª…ì—¬ëŒ€",
    // ìˆ˜ë„ê¶Œ ì£¼ìš” ëŒ€í•™ ì˜ˆì‹œ(ì›í•˜ë©´ ì¶”ê°€)
    "ì¸í•˜ëŒ€","ì•„ì£¼ëŒ€","ê°€ì²œëŒ€","ë‹¨êµ­ëŒ€","êµ­ë¯¼ëŒ€","ìˆ­ì‹¤ëŒ€","ì„¸ì¢…ëŒ€","ê´‘ìš´ëŒ€","ì„œìš¸ì‹œë¦½ëŒ€"
  ];

  // "XXëŒ€(ìº í¼ìŠ¤)"ì—ì„œ ê´„í˜¸ ì œê±°í•œ ë³¸ì²´ë§Œ ë¹„êµ
  const base = u.replace(/\([^)]+\)/g, "").trim();
  if (capitalByName.includes(base)) return true;

  return null; // ëª¨ë¦„(íŒì • ë¶ˆê°€)
}

// 6) ìµœì¢… ìˆ˜ë„ê¶Œ íŒì •: regionì´ ìˆìœ¼ë©´ ìš°ì„  ì“°ë˜, ìº í¼ìŠ¤ ì˜ˆì™¸ëŠ” ëŒ€í•™ëª…ìœ¼ë¡œ ë®ì–´ì”€
function isCapitalRegion(rec) {
  const reg = (rec.region || "").trim();
  const byRegion = (reg === "ì„œìš¸" || reg === "ê²½ê¸°" || reg === "ì¸ì²œ");

  const byUniv = inferCapitalByUniv(rec.univ); // true/false/null

  // ìº í¼ìŠ¤ ì˜ˆì™¸ì²˜ëŸ¼ "ëŒ€í•™ëª…ì´ ëª…í™•íˆ ë§í•´ì£¼ëŠ” ê²½ìš°"ëŠ” ëŒ€í•™ëª… íŒì • ìš°ì„ 
  if (byUniv === true) return true;
  if (byUniv === false) return false;

  // ëŒ€í•™ëª…ìœ¼ë¡œ íŒë‹¨ ëª» í•˜ë©´ ì§€ì—­ê°’ ì‚¬ìš©
  return byRegion;
}

// 7) íŠ¹ëª©ëŒ€ íŒì •(ëŒ€í•™ëª… ì •ê·œí™” í›„ ë² ì´ìŠ¤ëª… ë¹„êµ)
function isSpecialPurposeUniv(univRaw) {
  const u = normalizeUnivName(univRaw);
  const base = u.replace(/\([^)]+\)/g, "").trim();

  // ì˜ì–´/í•œê¸€ í˜¼ìš© ëŒ€ì‘(ì›í•˜ë©´ ë” ë³´ê°•)
  const key = base.toUpperCase();
  if (key === "KAIST") return true;
  if (key === "GIST") return true;
  if (key === "DGIST") return true;
  if (key === "UNIST") return true;

  // í•œê¸€ ëª…ì¹­ë“¤
  if (base.includes("í¬ìŠ¤í…")) return true;
  if (base.includes("í•œêµ­ì—ë„ˆì§€ê³µëŒ€")) return true;
  if (base.includes("ê²½ì°°ëŒ€")) return true;
  if (base.includes("ìœ¡ì‚¬")) return true;
  if (base.includes("í•´ì‚¬")) return true;
  if (base.includes("ê³µì‚¬")) return true;
  if (base.includes("êµ­ê°„ì‚¬")) return true;

  // í˜¹ì‹œ ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë„ ë³‘í–‰
  return SPECIAL_PURPOSE_UNIVS.includes(base);
}

    
    function renderFullReport(records) {
      plotsData = {};
      plotInitialized = {};
      currentGradeType = "all_subj";

      const univs = unique(records.map((r) => r.univ));
      const depts = unique(records.map((r) => r.dept));
      const apptypes = unique(records.map((r) => r.apptype));
      const subtypes = unique(records.map((r) => r.subtype));

      const header = `
        <div class="fixed-header">
          <div class="header-content">
            <div class="header-top">
              <div class="site-title">modified by KO</div>
            </div>
            <h2 class="university-title">ìˆ˜ì‹œ ì…ì‹œ ê²°ê³¼ í†µê³„ í”„ë¡œê·¸ë¨ [í’ë¬´ê³ ë“±í•™êµ]</h2>

            <div class="controls-legend-wrapper" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
              <div class="grade-toggle-container" style="background:#f1eee7;border:1px solid var(--border);border-radius:12px;padding:10px;">
                <button id="btn-conv" class="grade-toggle-btn">í™˜ì‚°ë“±ê¸‰</button>
                <button id="btn-all" class="grade-toggle-btn active">ì „êµê³¼100 ë“±ê¸‰</button>
              </div>

              <div class="legend-container" style="background:#f1eee7;border:1px solid var(--border);border-radius:12px;padding:10px;">
                <div class="legend-items-wrapper" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                  <div class="legend-item" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="legend-marker" style="font-size:18px;color:#5f8669;">&#9679;</span><span>í•©ê²© (Yì¶• ìƒë‹¨)</span>
                  </div>
                  <div class="legend-item" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="legend-marker" style="font-size:18px;color:#7cab7c;">&#9650;</span><span>ì¶©ì›í•©ê²© (Yì¶• ì¤‘ì•™)</span>
                  </div>
                  <div class="legend-item" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="legend-marker" style="font-size:18px;color:#d07a5c;">&#10006;</span><span>ë¶ˆí•©ê²© (Yì¶• í•˜ë‹¨)</span>
                  </div>
                </div>
                <div class="axis-label" style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-top:6px;">
                  <span>â†”</span><span id="grade-label">ì „êµê³¼100 ë“±ê¸‰</span> (1~9)
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      const layout = `
        <div class="layout">
          <aside class="toc-container">
            <div class="toc-header" style="font-weight:800;margin-bottom:10px;font-size:16px;">ëª©ì°¨</div>
            <div id="toc-content"></div>
          </aside>
          <main class="main-content" id="content-area"></main>
        </div>
      `;

      reportEl.hidden = false;
      reportEl.innerHTML = header + layout;

      const contentEl = document.getElementById("content-area");
      let plotCounter = 1;
      
contentEl.insertAdjacentHTML("beforeend", `
  <div class="dept-container" style="padding:14px 18px;background:#fff;border:1px solid var(--border);">
    <div style="font-weight:900;font-size:18px;margin:0 0 6px;">ë³´ê³ ì„œ</div>
    <div style="color:var(--muted);font-size:13px;line-height:1.4;">
      ì•„ë˜ëŠ” ì—…ë¡œë“œí•œ ì—‘ì…€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ëœ í†µê³„/ì‹œê°í™”ì…ë‹ˆë‹¤.
    </div>
  </div>
`);

      // ì¶œë ¥ ê¸°ì¤€ í‘œ
      // ì¶œë ¥ ê¸°ì¤€ í‘œ
      const filterSummary = `
        <div class="dept-container" style="margin-bottom:16px;">
          <div class="print-grade-line">
            ì¶œë ¥ ê¸°ì¤€: <span id="print-grade-text">ì „êµê³¼100 ë“±ê¸‰</span>
          </div>
          ì´ ${records.length}ê±´ Â· ëŒ€í•™ ${univs.length} Â· ëª¨ì§‘ë‹¨ìœ„ ${depts.length} Â· ì „í˜•ìœ í˜• ${apptypes.length} Â· ì „í˜• ${subtypes.length}
        </div>
      `;
      contentEl.insertAdjacentHTML("beforeend", filterSummary);

      // ì „ì²´ ìš”ì•½
      const overallBlock = buildPlotBlock(records, plotCounter, "ì „ì²´ ë°ì´í„°", true, true, true, true);
      plotsData[plotCounter] = overallBlock.data;

      contentEl.insertAdjacentHTML("beforeend", `
        <div class="dept-container" id="overall-summary">
          <div class="dept-header" style="border-bottom:2px solid #e74c3c;">ì „ì²´ ë°ì´í„° ìš”ì•½</div>
          ${overallBlock.html}
        </div>
      `);
      plotCounter++;

     // âœ… ì„œìš¸+ìˆ˜ë„ê¶Œ(ì§€ì—­/ëŒ€í•™ëª…) + íŠ¹ëª©ëŒ€ê¹Œì§€ ê°™ì´ í¬í•¨
const capitalRecords = records.filter(r => isCapitalRegion(r) || isSpecialPurposeUniv(r.univ));


// â€œìƒìœ„ê¶Œ ëŒ€í•™â€ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ í•œë²ˆ ë” í•„í„°(ì—†ìœ¼ë©´ ìˆ˜ë„ê¶Œ ì „ì²´ë¡œ)
const capitalTopTier = capitalRecords.filter(r => {
  const base = normalizeUnivName(r.univ).replace(/\([^)]+\)/g, "").trim();
  return TOP_TIER_UNIVS.includes(base);
});

const capitalTarget = capitalTopTier.length ? capitalTopTier : capitalRecords;

const capitalBlock = buildPlotBlock(capitalTarget, plotCounter, "ì„œìš¸+ìˆ˜ë„ê¶Œ", true, true, true, true);
plotsData[plotCounter] = capitalBlock.data;

contentEl.insertAdjacentHTML("beforeend", `
  <div class="dept-container" id="capital-summary">
    <div class="dept-header" style="border-bottom:2px solid #2c3e50;">ì„œìš¸+ìˆ˜ë„ê¶Œ ëŒ€í•™ ì§€ì› ë° í•©/ë¶ˆ í˜„í™©</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:10px;">
      ê¸°ì¤€: (1) ì§€ì—­=ì„œìš¸/ê²½ê¸°/ì¸ì²œ ë˜ëŠ” (2) ëŒ€í•™ëª… ë³´ì •(ìº í¼ìŠ¤ ì˜ˆì™¸ í¬í•¨) Â· ëŒ€ìƒ ${capitalTarget.length}ê±´
      ${capitalTopTier.length ? " Â· (ìƒìœ„ê¶Œ ëŒ€í•™ ë¦¬ìŠ¤íŠ¸ ì ìš©)" : ""}
    </div>
    ${capitalBlock.html}
  </div>
`);
plotCounter++;


// âœ… íŠ¹ëª©ëŒ€ ì„¹ì…˜
const specialRecords = records.filter(r => isSpecialPurposeUniv(r.univ));

const specialBlock = buildPlotBlock(specialRecords, plotCounter, "íŠ¹ìˆ˜ëª©ì ëŒ€í•™", true, true, true, true);
plotsData[plotCounter] = specialBlock.data;

contentEl.insertAdjacentHTML("beforeend", `
  <div class="dept-container" id="special-summary">
    <div class="dept-header" style="border-bottom:2px solid #8e44ad;">íŠ¹ìˆ˜ëª©ì ëŒ€í•™ ì§€ì› ë° í•©/ë¶ˆ í˜„í™©</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:10px;">
      ê¸°ì¤€: íŠ¹ì„±í™” ì´ê³µê³„/ì‚¬ê´€í•™êµ/ê²½ì°°ëŒ€ ë“± Â· ëŒ€ìƒ ${specialRecords.length}ê±´
    </div>
    ${specialBlock.html}
  </div>
`);
plotCounter++;

      
      // TOP20
      contentEl.insertAdjacentHTML("beforeend", `
        <div class="dept-container" id="univ-top-global">
          <div class="dept-header">ì§€ì› ìƒìœ„ ëŒ€í•™ TOP 20 í•©/ì¶©ì›/ë¶ˆí•©ê²©</div>
          <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
            <div id="univ-top-chart" class="plot-container" style="height:420px;"></div>
          </div>
        </div>
      `);

      // ëŒ€í•™ë³„ ì„¹ì…˜
      univs.forEach((univ, uIdx) => {
        const dfUniv = records.filter((r) => r.univ === univ);

        let html = `
          <div class="dept-container" id="univ-${uIdx + 1}">
            <div class="dept-header">${univ}</div>
        `;

        // ì „í˜•ìœ í˜•ë³„ ìš”ì•½
        const apptypesAll = unique(dfUniv.map((r) => r.apptype));
        if (apptypesAll.length) {
          html += `
            <div id="apptype-summary-${uIdx + 1}" style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fff;margin-bottom:14px;">
              <div style="font-weight:700;font-size:17px;margin-bottom:10px;">ì „í˜•ìœ í˜•ë³„ ìš”ì•½</div>
          `;
          apptypesAll.forEach((ap, aIdx) => {
            const subset = dfUniv.filter((r) => r.apptype === ap);
            const block = buildPlotBlock(subset, plotCounter, ap, true);
            html += `
              <div id="apptype-${uIdx + 1}-${aIdx + 1}" style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fefefe;margin:10px 0 0 8px;">
                <div style="font-weight:700;font-size:16px;margin-bottom:8px;">${ap}</div>
                ${block.html}
              </div>
            `;
            plotsData[plotCounter] = block.data;
            plotCounter++;
          });
          html += `</div>`;
        }

        // ì„¸ë¶€ìœ í˜•ë³„ ìš”ì•½
        const subtypesAll = unique(dfUniv.map((r) => r.subtype));
        if (subtypesAll.length) {
          html += `
            <div id="summary-container-${uIdx + 1}" style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fff;margin-bottom:14px;">
              <div style="font-weight:700;font-size:17px;margin-bottom:10px;">ì„¸ë¶€ìœ í˜•ë³„ ìš”ì•½</div>
          `;
          subtypesAll.forEach((st, sIdx) => {
            const subset = dfUniv.filter((r) => r.subtype === st);
            const block = buildPlotBlock(subset, plotCounter, st, true);
            html += `
              <div id="subtype-summary-${uIdx + 1}-${sIdx + 1}" style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fefefe;margin:10px 0 0 8px;">
                <div style="font-weight:700;font-size:16px;margin-bottom:8px;">${st}</div>
                ${block.html}
              </div>
            `;
            plotsData[plotCounter] = block.data;
            plotCounter++;
          });
          html += `</div>`;
        }

        // ëª¨ì§‘ë‹¨ìœ„ ìƒì„¸
        const univDepts = unique(dfUniv.map((r) => r.dept));
        univDepts.forEach((dept, dIdx) => {
          const dfDept = dfUniv.filter((r) => r.dept === dept);

          html += `
            <div id="dept-container-${uIdx + 1}-${dIdx + 1}" style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fff;margin-bottom:14px;">
              <!-- âœ… buildTOCê°€ ì°¾ëŠ” .subtype-header í´ë˜ìŠ¤ ë°˜ë“œì‹œ í¬í•¨ -->
              <div class="subtype-header" style="font-weight:700;font-size:16px;margin-bottom:10px;color:#34495e;">
                ${dIdx + 1}) ${dept}
              </div>
          `;

          const deptSubtypes = unique(dfDept.map((r) => r.subtype));
          deptSubtypes.forEach((st, sIdx) => {
            const subset = dfDept.filter((r) => r.subtype === st);
            if (!subset.length) return;
            const block = buildPlotBlock(subset, plotCounter, st, true);
            html += `
              <div id="subtype-${uIdx + 1}-${dIdx + 1}-${sIdx + 1}" style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fefefe;margin:10px 0 0 10px;">
                <div style="font-weight:700;font-size:15px;margin-bottom:8px;">${sIdx + 1}) ${st}</div>
                ${block.html}
              </div>
            `;
            plotsData[plotCounter] = block.data;
            plotCounter++;
          });

          html += `</div>`;
        });

        html += `</div>`;
        contentEl.insertAdjacentHTML("beforeend", html);
      });

      bindGradeToggle();
      initPlots();
      buildTOC();
      syncStickyTop();
    }

    function syncStickyTop() {
      const header = document.querySelector(".fixed-header");
      if (!header) return;
      const h = header.offsetHeight || 0;
      const top = Math.max(160, h + 16);
      document.documentElement.style.setProperty("--stickyTop", top + "px");
    }
    window.addEventListener("resize", syncStickyTop);
  </script>

  <script>
    function buildPlotBlock(dataArr, plotId, title, showStats = true, includeHist = false, includeBands = false, includeApptype = false) {
      const convStats = computeStats(dataArr, "conv_grade");
      const allStats  = computeStats(dataArr, "all_subj_grade");
      const convDetail = computeAdditionalStats(dataArr, "conv_grade");
      const allDetail  = computeAdditionalStats(dataArr, "all_subj_grade");
      const plotData = createPlotData(dataArr);

      const statsHtmlConv = showStats ? createStatsHtml(convStats) : "";
      const statsHtmlAll  = showStats ? createStatsHtml(allStats) : "";
      const detailConv = showStats ? createDetailTable(convDetail, "í™˜ì‚°ë“±ê¸‰") : "";
      const detailAll  = showStats ? createDetailTable(allDetail, "ì „êµê³¼ë“±ê¸‰") : "";

      let extraHtml = "";

      if (includeHist) {
        extraHtml += `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:10px;">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „êµê³¼ë“±ê¸‰ íˆìŠ¤í† ê·¸ë¨</h3>
              <div id="hist-all-${plotId}" class="plot-container" style="height:260px;"></div>
            </div>
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">í™˜ì‚°ë“±ê¸‰ íˆìŠ¤í† ê·¸ë¨</h3>
              <div id="hist-conv-${plotId}" class="plot-container" style="height:260px;"></div>
            </div>
          </div>
        `;
      }

      if (includeBands) {
        extraHtml += `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:10px;">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „êµê³¼ ë“±ê¸‰ëŒ€ë³„ í•©ê²©/ë¶ˆí•©ê²©</h3>
              <div id="band-bar-${plotId}" class="plot-container" style="height:280px;"></div>
            </div>
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ë“±ê¸‰ëŒ€ë³„ í†µê³„</h3>
              <div id="band-table-${plotId}"></div>
            </div>
          </div>
        `;
      }

      if (includeApptype) {
        extraHtml += `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:10px;">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „í˜•ìœ í˜•ë³„ í•©/ë¶ˆ í˜„í™©</h3>
              <div id="apptype-bar-${plotId}" class="plot-container" style="height:280px;"></div>
            </div>
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „í˜•ìœ í˜•ë³„ í†µê³„</h3>
              <div id="apptype-table-${plotId}"></div>
            </div>
          </div>
        `;
      }

      const html = `
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div id="conv-stats-${plotId}" style="display:none;flex-wrap:wrap;gap:8px;">${statsHtmlConv}</div>
          <div id="all-stats-${plotId}" style="display:flex;flex-wrap:wrap;gap:8px;">${statsHtmlAll}</div>

          <div class="plot-container" id="plot-${plotId}" style="width:100%;height:220px;"></div>

          <div id="conv-detail-${plotId}" style="display:none;">${detailConv}</div>
          <div id="all-detail-${plotId}" style="display:block;">${detailAll}</div>

          ${extraHtml}
        </div>
      `;

      return { html, data: plotData };
    }

    function createPlotData(dataArr) {
const studentLabel = (r) => {
  // ì´ë¦„ ë§ˆìŠ¤í‚¹: ê°€ìš´ë° ì „ë¶€ * (ì˜ˆ: ê³ ***ì¬, 3***4)
  const maskName = (name) => {
    name = (name || "").trim();
    if (!name) return "";

    // ê³µë°± í¬í•¨ ì´ë¦„(ì˜ˆ: "í™ ê¸¸ë™")ë„ ì²˜ë¦¬
    const raw = name.replace(/\s+/g, "");
    const len = raw.length;

    if (len === 1) return raw;                 // "ê³ "
    if (len === 2) return raw[0] + "*";        // "ê³ *"
    return raw[0] + "*".repeat(len - 2) + raw[len - 1]; // "ê³ ***ì¬"
  };

  // í•™ë…„-ë°˜-ë²ˆí˜¸ëŠ” ê°œì¸ì •ë³´ ë¯¼ê°ë„ ë‚®ì§€ë§Œ, ì™¸ë¶€ìš©ì´ë©´ ë…¸ì¶œ ìµœì†Œí™” ê¶Œì¥
  // â†’ í•„ìš”í•˜ë©´ ì¼œê³  ëŒ ìˆ˜ ìˆê²Œ ì˜µì…˜í™”
  const SHOW_ID = false; // trueë¡œ ë°”ê¾¸ë©´ (í•™ë…„-ë°˜-ë²ˆí˜¸) í‘œì‹œ

  const masked = maskName(r.student_name);
  const g = (r.grade || "").trim();
  const c = (r.class_no || "").trim();
  const n = (r.student_no || "").trim();
  const tail = [g, c, n].filter(Boolean).join("-");

  if (!masked && !(SHOW_ID && tail)) return "";
  if (SHOW_ID && tail) return `í•™ìƒ: ${masked || "ìµëª…"} (${tail})`;
  return `í•™ìƒ: ${masked || "ìµëª…"}`;
};


      const convTraces = RESULT_ORDER.map((res) => {
        const rows = dataArr.filter((r) => r.result === res && r.conv_grade !== null);
        return {
          x: rows.map((r) => r.conv_grade),
          y: rows.map(() => Y_POS[res] ?? 0),
          type: "scatter",
          mode: "markers",
          name: res,
          marker: {
            color: COLOR_MAP[res].fill,
            line: { color: COLOR_MAP[res].border, width: 1.5 },
            symbol: SYMBOL_MAP[res] || "circle",
            size: 12,
          },
          customdata: rows.map((r) => [r.dept, r.subtype, r.univ, studentLabel(r)]),
          hovertemplate:
            "í™˜ì‚°ë“±ê¸‰: %{x}<br>ëŒ€í•™: %{customdata[2]}<br>ëª¨ì§‘ë‹¨ìœ„: %{customdata[0]}<br>ì„¸ë¶€ìœ í˜•: %{customdata[1]}<br>%{customdata[3]}<extra></extra>",
          showlegend: false,
        };
      });

      const allTraces = RESULT_ORDER.map((res) => {
        const rows = dataArr.filter((r) => r.result === res && r.all_subj_grade !== null);
        return {
          x: rows.map((r) => r.all_subj_grade),
          y: rows.map(() => Y_POS[res] ?? 0),
          type: "scatter",
          mode: "markers",
          name: res,
          marker: {
            color: COLOR_MAP[res].fill,
            line: { color: COLOR_MAP[res].border, width: 1.5 },
            symbol: SYMBOL_MAP[res] || "circle",
            size: 12,
          },
          customdata: rows.map((r) => [r.dept, r.subtype, r.univ, studentLabel(r)]),
          hovertemplate:
            "ì „êµê³¼ë“±ê¸‰: %{x}<br>ëŒ€í•™: %{customdata[2]}<br>ëª¨ì§‘ë‹¨ìœ„: %{customdata[0]}<br>ì„¸ë¶€ìœ í˜•: %{customdata[1]}<br>%{customdata[3]}<extra></extra>",
          showlegend: false,
        };
      });

      return { convTraces, allTraces };
    }

    function createStatsHtml(stats) {
      const items = [];
      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#e4e0d7;border:1px solid #d6cebf;font-size:13px;font-weight:800;">ì´ ${stats.total_count}ëª…</div>`);

      if (stats.all_pass_count !== undefined) {
        items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid var(--primary);">
          í•©ê²©(ì „ì²´): ${stats.all_pass_count}ëª… (${stats.all_pass_rate || "0%"}), ë²”ìœ„ ${fmt(stats.all_pass_min)}~${fmt(stats.all_pass_max)}, í‰ê·  ${fmt(stats.all_pass_mean)}
        </div>`);
      }

      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid var(--primary);">
        í•©ê²©(ì¼ë°˜): ${stats.pass_count}ëª… (${stats.pass_rate})
      </div>`);

      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid #7cab7c;">
        ì¶©ì›í•©ê²©: ${stats.waitlist_count}ëª… (${stats.waitlist_rate})
      </div>`);

      const failRate = stats.total_count ? ((stats.fail_count / stats.total_count) * 100).toFixed(1) + "%" : "0.0%";
      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid #d26c5b;">
        ë¶ˆí•©ê²©: ${stats.fail_count}ëª… (${failRate})
      </div>`);

      return items.join("");
    }

    function createDetailTable(detail, title) {
      const rows = RESULT_ORDER.map((res) => {
        const d = detail[res] || {};
        if (!d.count) return `<tr><td>${res}</td><td colspan="6">ë°ì´í„° ì—†ìŒ</td></tr>`;
        return `<tr>
          <td>${res}</td>
          <td>${d.count}ëª…</td>
          <td>${fmt(d.mean)}</td>
          <td>${fmt(d.std)}</td>
          <td>${fmt(d.min)} ~ ${fmt(d.max)}</td>
          <td>${fmt(d.median)}</td>
          <td>${fmtRange(d.q1, d.q3)}</td>
        </tr>`;
      }).join("");

      return `
        <div style="border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px;">
          <h3 style="margin:0 0 8px;font-size:15px;">${title} ìƒì„¸ í†µê³„</h3>
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">ê²°ê³¼</th>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">ì¸ì›</th>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">í‰ê· </th>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">í‘œì¤€í¸ì°¨</th>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">ë²”ìœ„</th>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">ì¤‘ì•™ê°’</th>
                <th style="border:1px solid #e4ddcf;padding:7px;background:#f1ede5;">1Q-3Q</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function computeStats(dataArr, gradeKey) {
      const total = dataArr.length;
      const counts = RESULT_ORDER.reduce((acc, r) => {
        acc[r] = dataArr.filter((d) => d.result === r).length;
        return acc;
      }, {});

      const passData = dataArr
        .filter((d) => d.result === "í•©ê²©" || d.result === "ì¶©ì›í•©ê²©")
        .map((d) => d[gradeKey])
        .filter((v) => v !== null);

      const stats = {
        total_count: total,
        pass_count: counts["í•©ê²©"] || 0,
        waitlist_count: counts["ì¶©ì›í•©ê²©"] || 0,
        fail_count: counts["ë¶ˆí•©ê²©"] || 0,
      };

      stats.all_pass_count = stats.pass_count + stats.waitlist_count;
      stats.pass_rate = total ? ((stats.pass_count / total) * 100).toFixed(1) + "%" : "0.0%";
      stats.waitlist_rate = total ? ((stats.waitlist_count / total) * 100).toFixed(1) + "%" : "0.0%";
      stats.all_pass_rate = total ? ((stats.all_pass_count / total) * 100).toFixed(1) + "%" : "0.0%";

      if (passData.length) {
        stats.all_pass_min = Math.min(...passData);
        stats.all_pass_max = Math.max(...passData);
        stats.all_pass_mean = mean(passData);
      }
      return stats;
    }

    function computeAdditionalStats(dataArr, key) {
      const out = {};
      RESULT_ORDER.forEach((res) => {
        const arr = dataArr.filter((d) => d.result === res).map((d) => d[key]).filter((v) => v !== null);
        if (!arr.length) { out[res] = { count: 0 }; return; }
        out[res] = {
          count: arr.length,
          mean: mean(arr),
          std: stddev(arr),
          min: Math.min(...arr),
          max: Math.max(...arr),
          median: percentile(arr, 50),
          q1: percentile(arr, 25),
          q3: percentile(arr, 75),
        };
      });
      return out;
    }

    function mean(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }
    function stddev(arr) {
      if (arr.length < 2) return 0;
      const m = mean(arr);
      return Math.sqrt(arr.reduce((s, v) => s + Math.pow(v - m, 2), 0) / (arr.length - 1));
    }
    function percentile(arr, p) {
      if (!arr.length) return 0;
      const s = [...arr].sort((a, b) => a - b);
      const rank = (p / 100) * (s.length - 1);
      const l = Math.floor(rank);
      const h = Math.ceil(rank);
      if (l === h) return s[l];
      const w = rank - l;
      return s[l] * (1 - w) + s[h] * w;
    }
    function fmt(v) { return v === undefined || v === null || Number.isNaN(v) ? "-" : Number(v).toFixed(2); }
    function fmtRange(a, b) { if ([a, b].some((x) => x === undefined || x === null || Number.isNaN(x))) return "-"; return `${Number(a).toFixed(2)} ~ ${Number(b).toFixed(2)}`; }

    function createLayout() {
      return {
        height: 220,
        autosize: true,
        margin: { t: 12, b: 45, l: 55, r: 25 },
        xaxis: {
          range: [0.5, 9.5],
          tickmode: "array",
          tickvals: [1,2,3,4,5,6,7,8,9],
          ticktext: ["1","2","3","4","5","6","7","8","9"],
          title: "ë“±ê¸‰"
        },
        yaxis: {
          range: [-0.05, 0.05],
          tickmode: "array",
          tickvals: [0.01, 0.0, -0.03],
          ticktext: ["", "", ""],
          showgrid: false,
          zeroline: false
        },
        showlegend: false,
        plot_bgcolor: "#fff",
        paper_bgcolor: "#fff",
      };
    }

    function initPlots() {
      document.querySelectorAll(".plot-container[id^='plot-']").forEach((div) => {
        const id = div.id.split("-")[1];
        const data = plotsData[id];
        if (!data) return;
        const traces = currentGradeType === "conv" ? data.convTraces : data.allTraces;
        Plotly.newPlot(div, traces, createLayout(), { displayModeBar: false, responsive: true });
        plotInitialized[id] = true;
      });

      // ì „ì²´ ìš”ì•½ ë¸”ë¡ì—ë§Œ ë¶™ëŠ” ì¶”ê°€ ì‹œê°í™”
      Object.keys(plotsData).forEach((pid) => {
        if (document.getElementById(`hist-all-${pid}`)) {
          renderHist(lastRecords, "all_subj_grade", `hist-all-${pid}`, "ì „êµê³¼ë“±ê¸‰");
        }
        if (document.getElementById(`hist-conv-${pid}`)) {
          renderHist(lastRecords, "conv_grade", `hist-conv-${pid}`, "í™˜ì‚°ë“±ê¸‰");
        }
        if (document.getElementById(`band-bar-${pid}`)) {
          renderGradeBands(lastRecords, "all_subj_grade", pid);
        }
        if (document.getElementById(`apptype-bar-${pid}`)) {
          renderApptypeStats(lastRecords, pid);
        }
      });

      renderUnivTop(lastRecords);
    }

    function updateAllPlots() {
      document.querySelectorAll(".plot-container[id^='plot-']").forEach((div) => {
        const id = div.id.split("-")[1];
        const data = plotsData[id];
        if (!data || !plotInitialized[id]) return;
        const traces = currentGradeType === "conv" ? data.convTraces : data.allTraces;
        Plotly.react(div, traces, createLayout(), { displayModeBar: false, responsive: true });
      });
    }

    function bindGradeToggle() {
      const btnConv = document.getElementById("btn-conv");
      const btnAll  = document.getElementById("btn-all");
      btnConv.onclick = () => switchGrade("conv");
      btnAll.onclick  = () => switchGrade("all_subj");
    }

    function switchGrade(type) {
      if (currentGradeType === type) return;
      currentGradeType = type;

      document.getElementById("btn-conv").classList.toggle("active", type === "conv");
      document.getElementById("btn-all").classList.toggle("active", type === "all_subj");

      document.getElementById("grade-label").textContent = type === "conv" ? "í™˜ì‚°ë“±ê¸‰" : "ì „êµê³¼100 ë“±ê¸‰";
      const pg = document.getElementById("print-grade-text");
      if (pg) pg.textContent = type === "conv" ? "í™˜ì‚°ë“±ê¸‰" : "ì „êµê³¼100 ë“±ê¸‰";

      document.querySelectorAll("[id^='conv-stats-']").forEach((el) => el.style.display = type === "conv" ? "flex" : "none");
      document.querySelectorAll("[id^='all-stats-']").forEach((el)  => el.style.display = type === "all_subj" ? "flex" : "none");
      document.querySelectorAll("[id^='conv-detail-']").forEach((el)=> el.style.display = type === "conv" ? "block" : "none");
      document.querySelectorAll("[id^='all-detail-']").forEach((el) => el.style.display = type === "all_subj" ? "block" : "none");

      updateAllPlots();
    }

    function buildTOC() {
      const toc = document.getElementById("toc-content");
      let html = "";

      document.querySelectorAll(".dept-container").forEach((container) => {
        const header = container.querySelector(".dept-header");
        if (!header) return;

        const id = container.id;
        html += `<div style="font-weight:700;cursor:pointer;padding:6px;border-radius:8px;color:var(--primary-dark);" onclick="scrollToElement('${id}')">${header.textContent}</div>`;

        const apSummary = container.querySelector("[id^='apptype-summary-']");
        if (apSummary) html += `<div style="margin-left:10px;"><div style="font-size:13px;cursor:pointer;padding:4px 6px;border-radius:6px;" onclick="scrollToElement('${apSummary.id}')">ì „í˜•ìœ í˜•ë³„ ìš”ì•½</div></div>`;

        const stSummary = container.querySelector("[id^='summary-container-']");
        if (stSummary) html += `<div style="margin-left:10px;"><div style="font-size:13px;cursor:pointer;padding:4px 6px;border-radius:6px;" onclick="scrollToElement('${stSummary.id}')">ì„¸ë¶€ìœ í˜•ë³„ ìš”ì•½</div></div>`;

        // âœ… ëª¨ì§‘ë‹¨ìœ„(í•™ê³¼)ê¹Œì§€ ëª©ì°¨ë¡œ ë‚´ë¦¬ê¸°
        container.querySelectorAll("[id^='dept-container-']").forEach((deptEl) => {
          const deptHeader = deptEl.querySelector(".subtype-header"); // ìœ„ì—ì„œ ë„£ì€ í´ë˜ìŠ¤
          if (!deptHeader) return;
          html += `<div style="margin-left:14px;font-size:12.5px;cursor:pointer;padding:4px 6px;border-radius:6px;color:#2f3c32;" onclick="scrollToElement('${deptEl.id}')">- ${deptHeader.textContent}</div>`;
        });
      });
      toc.innerHTML = html;
    }

    function scrollToElement(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const headerHeight = document.querySelector(".fixed-header")?.offsetHeight || 0;
      const top = el.getBoundingClientRect().top + window.pageYOffset - headerHeight - 10;
      window.scrollTo({ top, behavior: "smooth" });
    }
    window.scrollToElement = scrollToElement;

    function makeHistogramSeries(records, key) {
      const passArr = records
        .filter((r) => r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©")
        .map((r) => r[key]).filter((v) => v !== null);
      const failArr = records
        .filter((r) => r.result === "ë¶ˆí•©ê²©")
        .map((r) => r[key]).filter((v) => v !== null);

      const edges = [];
      for (let v = BINS.start; v < BINS.end; v += BINS.size) edges.push(Number(v.toFixed(4)));
      edges.push(BINS.end);

      const bins = edges.length - 1;
      const passCounts = new Array(bins).fill(0);
      const failCounts = new Array(bins).fill(0);
      const center = [];
      for (let i = 0; i < bins; i++) center.push((edges[i] + edges[i + 1]) / 2);

      const fillCounts = (arr, target) => {
        arr.forEach((v) => {
          if (v < BINS.start || v > BINS.end) return;
          const idx = Math.min(Math.floor((v - BINS.start) / BINS.size), bins - 1);
          target[idx] += 1;
        });
      };
      fillCounts(passArr, passCounts);
      fillCounts(failArr, failCounts);

      return { center, passCounts, failCounts };
    }

    function makeGradeBandStats(records, key) {
      const bands = [
        { label: "1ë“±ê¸‰ëŒ€", from: 1, to: 1.999 },
        { label: "2ë“±ê¸‰ëŒ€", from: 2, to: 2.999 },
        { label: "3ë“±ê¸‰ëŒ€", from: 3, to: 3.999 },
        { label: "4ë“±ê¸‰ëŒ€", from: 4, to: 4.999 },
        { label: "5ë“±ê¸‰ëŒ€", from: 5, to: 5.999 },
        { label: "6ë“±ê¸‰ëŒ€", from: 6, to: 6.999 },
        { label: "7ë“±ê¸‰ëŒ€", from: 7, to: 7.999 },
        { label: "8ë“±ê¸‰ëŒ€", from: 8, to: 8.999 },
        { label: "9ë“±ê¸‰ëŒ€", from: 9, to: 9.999 },
      ];
      return bands.map((b) => {
        const inBand = records.filter((r) => r[key] !== null && r[key] >= b.from && r[key] <= b.to);
        const pass = inBand.filter((r) => r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©").length;
        const fail = inBand.filter((r) => r.result === "ë¶ˆí•©ê²©").length;
        const total = pass + fail;
        return { label: b.label, pass, fail, total, passRate: total ? (pass / total) * 100 : 0 };
      });
    }

    function renderGradeBands(records, key, targetPlotId) {
      const stats = makeGradeBandStats(records, key);
      const labels = stats.map((s) => s.label);
      const passCounts = stats.map((s) => s.pass);
      const failCounts = stats.map((s) => s.fail);
      const hasData = stats.some((s) => s.total > 0);

      const barEl = document.getElementById(`band-bar-${targetPlotId}`);
      const tableEl = document.getElementById(`band-table-${targetPlotId}`);

      if (barEl) {
        if (!hasData) {
          barEl.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          Plotly.newPlot(barEl, [
            { x: labels, y: passCounts, type: "bar", name: "í•©ê²©(ì¶©ì›í¬í•¨)", marker: { color: COLOR_MAP["í•©ê²©"].border } },
            { x: labels, y: failCounts, type: "bar", name: "ë¶ˆí•©ê²©", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border } },
          ], {
            height: 280,
            barmode: "stack",
            margin: { t: 20, b: 40, l: 45, r: 20 },
            yaxis: { title: "ì¸ì›" },
          }, { displayModeBar: false, responsive: true });
        }
      }

      if (tableEl) {
        const rows = stats.map((s) => {
          if (!s.total) return `<tr><td>${s.label}</td><td colspan="4">ë°ì´í„° ì—†ìŒ</td></tr>`;
          return `<tr><td>${s.label}</td><td>${s.pass}</td><td>${s.fail}</td><td>${s.total}</td><td>${s.passRate.toFixed(1)}%</td></tr>`;
        }).join("");
        tableEl.innerHTML = `<table class="stats-table">
          <thead><tr><th>ë“±ê¸‰ëŒ€</th><th>í•©ê²©</th><th>ë¶ˆí•©ê²©</th><th>ì´ì›</th><th>í•©ê²©ë¥ </th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      }
    }

    function makeApptypeStats(records) {
      const groups = {};
      records.forEach((r) => {
        const key = r.apptype || "ë¯¸ìƒ";
        if (!groups[key]) groups[key] = { total: 0, pass: 0, wait: 0, fail: 0 };
        groups[key].total += 1;
        if (r.result === "í•©ê²©") groups[key].pass += 1;
        else if (r.result === "ì¶©ì›í•©ê²©") groups[key].wait += 1;
        else if (r.result === "ë¶ˆí•©ê²©") groups[key].fail += 1;
      });
      return Object.entries(groups).map(([apptype, g]) => {
        const total = g.total || 1;
        return {
          apptype,
          total: g.total,
          pass: g.pass,
          wait: g.wait,
          fail: g.fail,
          passRate: (g.pass / total) * 100,
          waitRate: (g.wait / total) * 100,
          failRate: (g.fail / total) * 100,
        };
      }).sort((a, b) => b.total - a.total);
    }

    function renderApptypeStats(records, plotId) {
      const stats = makeApptypeStats(records);
      const labels = stats.map((s) => s.apptype);
      const passCounts = stats.map((s) => s.pass);
      const waitCounts = stats.map((s) => s.wait);
      const failCounts = stats.map((s) => s.fail);
      const hasData = stats.some((s) => s.total > 0);

      const barEl = document.getElementById(`apptype-bar-${plotId}`);
      const tableEl = document.getElementById(`apptype-table-${plotId}`);

      if (barEl) {
        if (!hasData) {
          barEl.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          Plotly.newPlot(barEl, [
            { y: labels, x: passCounts, type: "bar", name: "í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["í•©ê²©"].border } },
            { y: labels, x: waitCounts, type: "bar", name: "ì¶©ì›í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ì¶©ì›í•©ê²©"].border } },
            { y: labels, x: failCounts, type: "bar", name: "ë¶ˆí•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border } },
          ], {
            height: Math.max(240, 26 * labels.length + 80),
            barmode: "stack",
            margin: { t: 20, b: 40, l: 120, r: 20 },
            xaxis: { title: "ì¸ì›" },
          }, { displayModeBar: false, responsive: true });
        }
      }

      if (tableEl) {
        const rows = stats.map((s) => {
          if (!s.total) return `<tr><td>${s.apptype}</td><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>`;
          return `<tr>
            <td>${s.apptype}</td><td>${s.total}</td><td>${s.pass}</td><td>${s.wait}</td><td>${s.fail}</td>
            <td>${s.passRate.toFixed(1)}%</td><td>${s.waitRate.toFixed(1)}%</td><td>${s.failRate.toFixed(1)}%</td>
          </tr>`;
        }).join("");
        tableEl.innerHTML = `<table class="stats-table">
          <thead><tr><th>ì „í˜•ìœ í˜•</th><th>ì´ì›</th><th>í•©ê²©</th><th>ì¶©ì›í•©ê²©</th><th>ë¶ˆí•©ê²©</th><th>í•©ê²©ë¥ </th><th>ì¶©ì›ë¥ </th><th>ë¶ˆí•©ê²©ë¥ </th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      }
    }

    function renderUnivTop(records) {
      const univTopEl = document.getElementById("univ-top-chart");
      if (!univTopEl) return;

      const grouped = {};
      records.forEach((r) => {
        const key = r.univ || "ë¯¸ìƒ";
        if (!grouped[key]) grouped[key] = { pass: 0, wait: 0, fail: 0, total: 0 };
        grouped[key].total += 1;
        if (r.result === "í•©ê²©") grouped[key].pass += 1;
        else if (r.result === "ì¶©ì›í•©ê²©") grouped[key].wait += 1;
        else if (r.result === "ë¶ˆí•©ê²©") grouped[key].fail += 1;
      });

      const sorted = Object.entries(grouped)
        .map(([univ, g]) => ({ univ, ...g }))
        .filter((x) => x.total > 0)
        .sort((a, b) => b.total - a.total)
        .slice(0, 20);

      if (!sorted.length) {
        univTopEl.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
        return;
      }

      const labelsTop = sorted.map((s) => s.univ);
      const passTop = sorted.map((s) => s.pass);
      const waitTop = sorted.map((s) => s.wait);
      const failTop = sorted.map((s) => s.fail);

      const dynamicHeight = Math.max(360, 26 * labelsTop.length + 110);
      univTopEl.style.height = dynamicHeight + "px";

      Plotly.newPlot(univTopEl, [
        { y: labelsTop, x: passTop, type: "bar", name: "í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["í•©ê²©"].border } },
        { y: labelsTop, x: waitTop, type: "bar", name: "ì¶©ì›í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ì¶©ì›í•©ê²©"].border } },
        { y: labelsTop, x: failTop, type: "bar", name: "ë¶ˆí•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border } },
      ], {
        height: dynamicHeight,
        barmode: "stack",
        margin: { t: 24, b: 40, l: 150, r: 24 },
        xaxis: { title: "ì¸ì›" },
      }, { displayModeBar: false, responsive: true });
    }

    function renderHist(records, key, targetId, title) {
      const el = document.getElementById(targetId);
      if (!el) return;

      const { center, passCounts, failCounts } = makeHistogramSeries(records, key);
      const hasData = passCounts.some((c) => c > 0) || failCounts.some((c) => c > 0);
      if (!hasData) { el.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>'; return; }

      const maxVal = Math.max(...passCounts, ...failCounts, 0);

      Plotly.newPlot(el, [
        { x: center, y: passCounts, type: "bar", name: "í•©ê²©(ì¶©ì›í¬í•¨)", marker: { color: COLOR_MAP["í•©ê²©"].border }, width: BINS.size * 0.9 },
        { x: center, y: failCounts.map((v) => -v), type: "bar", name: "ë¶ˆí•©ê²©", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border }, width: BINS.size * 0.9 },
      ], {
        height: 260,
        barmode: "relative",
        bargap: 0.02,
        margin: { t: 20, b: 45, l: 50, r: 20 },
        xaxis: { title: "ë“±ê¸‰", range: [BINS.start, BINS.end] },
        yaxis: { title: "ì¸ì›(+í•©ê²© / -ë¶ˆí•©ê²©)", zeroline: true, range: [-maxVal * 1.2, maxVal * 1.2] },
      }, { displayModeBar: false, responsive: true });
    }
  </script>

</body>
</html>
