<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í’ë¬´ê³ ë“±í•™êµ ìˆ˜ì‹œ ì…ì‹œ ê²°ê³¼ í†µê³„í”„ë¡œê·¸ë¨</title>

  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <style>
    :root {
      --bg: #f6f4ef;
      --card: #ffffff;
      --border: #d9d2c3;
      --primary: #6b8f71;
      --primary-dark: #58765e;
      --accent: #d07a5c;
      --text: #2f3c32;
      --muted: #6a7065;
      --shadow: 0 10px 28px rgba(47,60,50,0.12);
      --stickyTop: 190px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans KR", "Pretendard", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* âœ… í‘œ/ë¹ˆë°ì´í„° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .stats-table th, .stats-table td {
      border: 1px solid #e4ddcf;
      padding: 7px;
      text-align: center;
    }
    .stats-table thead th {
      background: #f1ede5;
      font-weight: 800;
    }
    .empty {
      padding: 18px;
      border: 1px dashed #d9d2c3;
      border-radius: 12px;
      color: var(--muted);
      text-align: center;
      background: #fff;
    }

    /* ===== ìƒë‹¨ ===== */
    .hero {
      padding: 28px 20px 14px;
      text-align: center;
    }

    .panel {
      max-width: 1160px;
      margin: 0 auto 18px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    /* âœ… ì—…ë¡œë“œ ì¤„ ì •ë ¬(í•œ ì¤„ ìœ ì§€) */
    .panel .field {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: nowrap;
    }
    .panel .field #file-input{
      flex: 1 1 auto;
      min-width: 260px;
      max-width: 520px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      flex: 0 0 auto;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #eef0eb;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      white-space: nowrap;
    }
    button.primary {
      background: var(--primary);
      color: #fff;
    }
    button.accent {
      background: var(--accent);
      color: #fff;
      border-color: #c56f55;
    }

    /* âœ… í™”ë©´ ì¢ì„ ë•Œë§Œ ì¤„ë°”ê¿ˆ */
    @media (max-width: 700px){
      .panel .field { flex-wrap: wrap; align-items: stretch; }
      .panel .field #file-input { max-width: 100%; }
      .actions { width: 100%; flex-wrap: wrap; }
    }

    /* ===== ê³ ì • í—¤ë” ===== */
    .fixed-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: transparent;
      border-bottom: none;
      box-shadow: none;
      padding: 10px 0;
    }
    .fixed-header::after{
      content:"";
      display:block;
      height: 8px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;

      background: rgba(255,255,255,0.96);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }

    .site-title{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .university-title{
      margin: 4px 0 2px;
      font-size: 20px;
      font-weight: 900;
    }

    .grade-toggle-btn.active {
      background: var(--accent);
      color: #fff;
    }

    /* ===== ë ˆì´ì•„ì›ƒ ===== */
    .layout {
      max-width: 1200px;
      margin: 18px auto 32px;
      display: flex;
      gap: 16px;
      padding: 0 12px;
      align-items: flex-start;
    }

    .toc-container {
      flex: 0 0 220px;
      position: sticky;
      top: var(--stickyTop);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 14px 14px;
      box-shadow: var(--shadow);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .main-content { flex: 1; padding: 0; }

    .dept-container {
      margin-bottom: 28px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      background: #fff;
      box-shadow: var(--shadow);
    }

    .dept-header {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 14px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
    }

    .print-grade-line {
      font-weight: 800;
      margin-bottom: 6px;
    }

    #content-area > .dept-container:first-child{
      margin-top: 10px;
    }

    /* ===== ì¸ì‡„ ===== */
    @media print {
      @page { size: A4 portrait; margin: 12mm; }
      body { background: #fff !important; }

      .hero, .panel, .fixed-header, .toc-container {
        display: none !important;
      }

      .layout {
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      .dept-container {
        page-break-before: always;
        break-before: page;
        box-shadow: none;
        border: none;
      }

      /* âœ… ì²« ë¸”ë¡ì€ ê°•ì œ í˜ì´ì§€ ë¸Œë ˆì´í¬ ì œê±° */
      #overall-summary {
        page-break-before: auto !important;
        break-before: auto !important;
      }

      .plot-container { height: 320px !important; }

      /* ===== ì¶œë ¥ ëª¨ë“œ ë¶„ê¸° ===== */
      body.print-overall #report .dept-container:not(#overall-summary) {
        display: none !important;
      }
      body.print-capital #report .dept-container:not(#capital-summary) {
        display: none !important;
      }
      body.print-full #report { /* ì „ì²´ ì¶œë ¥ */ }

      body.print-overall #overall-summary,
      body.print-capital #capital-summary {
        page-break-before: auto !important;
        break-before: auto !important;
      }
    }
    /* ===== ì¸ì‡„ ì˜ë¦¼ ë°©ì§€(ì¶”ê°€) ===== */
@media print {
  /* ë°•ìŠ¤ ë‹¨ìœ„ë¡œ ìª¼ê°œì§€ì§€ ì•Šê²Œ */
  .dept-container,
  .dept-container > div,
  .dept-container table,
  .dept-container .plot-container,
  .dept-container .plot-container > div {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }

  /* í‘œëŠ” í–‰ ë‹¨ìœ„ë¡œë§Œ ìª¼ê°œì§€ê²Œ(í–‰ì´ ë°˜ìª½ë‚˜ëŠ” ê²ƒ ë°©ì§€) */
  table { page-break-inside: auto !important; }
  tr, td, th {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }

  /* Plotly/SVGê°€ ì˜ë¦¬ëŠ” ê²½ìš° ì™„í™” */
  svg, .main-svg {
    overflow: visible !important;
  }

  /* ë„ˆë¬´ ê¸¸ë©´ í˜ì´ì§€ ë°–ìœ¼ë¡œ ë°€ë¦¬ëŠ” ê²½ìš°ê°€ ìˆì–´ì„œ ì—¬ë°± í™•ë³´ */
  .dept-container { padding-bottom: 12mm !important; }
}

  </style>
</head>

<body>
  <header class="hero">
    <h1>ìˆ˜ì‹œ ì…ì‹œ ê²°ê³¼ í†µê³„ í”„ë¡œê·¸ë¨ [í’ë¬´ê³ ë“±í•™êµ]</h1>
    <p>ëŒ€êµí˜‘ìƒë‹´í”„ë¡œê·¸ë¨ - ì§„í•™ê´€ë¦¬ - ìˆ˜ì‹œì§„í•™ê´€ë¦¬ì˜ ì—‘ì…€íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>
  </header>

  <section class="panel">
    <h2>ì—‘ì…€ ì—…ë¡œë“œ</h2>
    <div class="field">
      <input type="file" id="file-input" accept=".xlsx,.xls" />
      <div class="actions">
        <button class="primary" id="generate-btn">ë³´ê³ ì„œ ìƒì„±</button>
        <button class="accent" id="print-overall-btn">í˜„í™© 1ë¶€(PDF)</button>
        <button class="accent" id="print-capital-btn">ì„œìš¸+ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€(PDF)</button>
        <button id="print-full-btn">ì „ì²´ ì¸ì‡„(PDF)</button>
        <button id="export-share-btn">ğŸ“¦ ê³µìœ ìš© JSON ì €ì¥</button>

      </div>
    </div>
    <div id="status"></div>
  </section>

  <section id="report" hidden></section>

  <script>
    const RESULT_ORDER = ["í•©ê²©", "ì¶©ì›í•©ê²©", "ë¶ˆí•©ê²©"];
    const COLOR_MAP = {
      "í•©ê²©":   { border: "#5f8669", fill: "rgba(95, 134, 105, 0.30)" },
      "ì¶©ì›í•©ê²©": { border: "#7cab7c", fill: "rgba(124, 171, 124, 0.28)" },
      "ë¶ˆí•©ê²©": { border: "#d07a5c", fill: "rgba(208, 122, 92, 0.32)" },
    };
    const SYMBOL_MAP = { "í•©ê²©": "circle", "ì¶©ì›í•©ê²©": "triangle-up", "ë¶ˆí•©ê²©": "x" };
    const Y_POS = { "í•©ê²©": 0.01, "ì¶©ì›í•©ê²©": 0.0, "ë¶ˆí•©ê²©": -0.03 };
    const BINS = { start: 1, end: 9, size: 0.5 };

    // âœ… íŠ¹ìˆ˜ëª©ì ëŒ€(í¬ìŠ¤í… ì œì™¸ / ì¼„í… í¬í•¨)
    const SPECIAL_UNIVS = new Set([
      "ì¹´ì´ìŠ¤íŠ¸","KAIST","í•œêµ­ê³¼í•™ê¸°ìˆ ì›",
      "ìœ ë‹ˆìŠ¤íŠ¸","UNIST","ìš¸ì‚°ê³¼í•™ê¸°ìˆ ì›",
      "ë””ì§€ìŠ¤íŠ¸","DGIST","ëŒ€êµ¬ê²½ë¶ê³¼í•™ê¸°ìˆ ì›",
      "ì§€ìŠ¤íŠ¸","GIST","ê´‘ì£¼ê³¼í•™ê¸°ìˆ ì›",
      "ì¼„í…","KENTECH","í•œêµ­ì—ë„ˆì§€ê³µê³¼ëŒ€í•™êµ"
    ]);

    // âœ… ì¶œë ¥ìš© ëŒ€í•™ëª… ë³´ì •(ì‚¬ìš©ì ì œê³µ ë§¤í•‘)
    const UNIV_ALIAS_MAP = new Map([
      ["êµ­ë¦½í•œêµ­í•´ì–‘ëŒ€í•™êµ(ë¶€ì‚°)", "í•œêµ­í•´ì–‘ëŒ€"],
      ["í•œì–‘ëŒ€í•™êµ(ERICA)", "í•œì–‘ëŒ€(ì—)"],
      ["ê´‘ì£¼ì—¬ìëŒ€í•™êµ(ê´‘ì£¼)", "ê´‘ì£¼ì—¬ëŒ€"],
      ["ì¤‘ë¶€ëŒ€í•™êµ(ê³ ì–‘) - ê³ ì–‘ìº í¼ìŠ¤", "ì¤‘ë¶€ëŒ€(ê³ )"],
      ["ì¤‘ë¶€ëŒ€í•™êµ(ê¸ˆì‚°) - ì¶©ì²­ìº í¼ìŠ¤", "ì¤‘ë¶€ëŒ€"],
      ["ë™êµ­ëŒ€í•™êµ(WISE)", "ë™êµ­ëŒ€(W)"],
      ["ì¤‘ì•™ëŒ€í•™êµ(ë‹¤ë¹ˆì¹˜) - ë‹¤ë¹ˆì¹˜ìº í¼ìŠ¤", "ì¤‘ì•™ëŒ€(ë‹¤)"],
      ["ì¤‘ì•™ëŒ€í•™êµ(ë‹¤ë¹ˆì¹˜)", "ì¤‘ì•™ëŒ€(ë‹¤)"],
      ["ê±´êµ­ëŒ€í•™êµ(ê¸€ë¡œì»¬)", "ê±´êµ­ëŒ€(ê¸€)"],
      ["ìƒëª…ëŒ€í•™êµ(ì²œì•ˆ)", "ìƒëª…ëŒ€(ì²œ)"],
      ["í•œêµ­ê¸°ìˆ êµìœ¡ëŒ€í•™êµ(ì²œì•ˆ)", "í•œêµ­ê¸°ìˆ êµëŒ€"],
      ["í•œêµ­í•­ê³µëŒ€í•™êµ(ê³ ì–‘)", "í•œêµ­í•­ê³µëŒ€"],
      ["í™ìµëŒ€í•™êµ(ì„¸ì¢…)", "í™ìµëŒ€(ì„¸)"],
    ]);

    const fileInput = document.getElementById("file-input");
    const statusEl  = document.getElementById("status");
    const reportEl  = document.getElementById("report");
    const generateBtn = document.getElementById("generate-btn");
    const WEBAPP_URL = "https://script.google.com/a/macros/ggh.goe.go.kr/s/AKfycbw8P5o17VRXe6idAmfNBeB7r407ebb6nVrYcAywlQkIWh6am5ukO2oM4ma1QYSzJ9ho/exec";

    let currentGradeType = "all_subj";
    let plotsData = {};
    let plotInitialized = {};
    let lastRecords = null;

    generateBtn.addEventListener("click", handleGenerate);


    /* =========================
   ì¸ì‡„(PDF) ë²„íŠ¼ ì´ë²¤íŠ¸
========================= */

    // âœ… 3ì¢… ì¶œë ¥ ë²„íŠ¼
    document.getElementById("print-overall-btn").addEventListener("click", () => printWithMode("overall"));
    document.getElementById("print-capital-btn").addEventListener("click", () => printWithMode("capital"));
    document.getElementById("print-full-btn").addEventListener("click", () => printWithMode("full"));

    const exportBtn = document.getElementById("export-share-btn");
exportBtn.addEventListener("click", exportShareJSON);

    
    // ì¸ì‡„ í›„ í´ë˜ìŠ¤ ë³µêµ¬
    window.addEventListener("afterprint", () => {
      document.body.classList.remove("print-overall","print-capital","print-full");
    });

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#c0392b" : "#607089";
    }

    function printWithMode(mode){
      if (reportEl.hidden) {
        alert("ë¨¼ì € ë³´ê³ ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!");
        return;
      }
      document.body.classList.remove("print-overall","print-capital","print-full");
      if (mode === "overall") document.body.classList.add("print-overall");
      if (mode === "capital") document.body.classList.add("print-capital");
      if (mode === "full") document.body.classList.add("print-full");
      window.print();
    }

function exportShareJSON() {
  if (!lastRecords || !lastRecords.length) {
    alert("ë¨¼ì € ë³´ê³ ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!");
    return;
  }

  // âœ… ì›ë³¸/ê°œì¸ì •ë³´ë¥¼ ë¹¼ê³  â€œê³µìœ ìš© ìš”ì•½â€ë§Œ ë‹´ê¸°
  const payload = buildSharePayload(lastRecords);

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  const stamp = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = `susi_report_share_${stamp}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => URL.revokeObjectURL(url), 500);
}

// âœ… ê³µìœ ìš© JSON: â€œëŒ€í•™/ì „í˜•/ê²°ê³¼/ë“±ê¸‰ í†µê³„â€ ì¤‘ì‹¬ (í•™ìƒëª…/í•™ë²ˆ ë“± ì œê±°)

    function buildSharePayload(records){
  // âœ… ìµëª…í™” records ë§Œë“¤ê¸°: ì´ë¦„ ì œê±° + ìƒë‹´ ì‹ë³„ìëŠ” ë°˜-ë²ˆí˜¸ë§Œ
  const safeRecords = records.map(r => {
    const classNo = (r.class_no ?? "").toString().trim();
    const studentNo = (r.student_no ?? "").toString().trim();

    return {
      // ì‹ë³„(í‘œì‹œ)ìš©: "ë°˜-ë²ˆí˜¸"ë§Œ
      sid: `${classNo}-${studentNo}`,

      // ë¶„ì„/í•„í„°ì— í•„ìš”í•œ ìµœì†Œ í•„ë“œë§Œ ìœ ì§€
      grade: r.grade ?? "",
      class_no: classNo,
      student_no: studentNo,

      region: r.region ?? "",
      univ: r.univ ?? "",
      dept: r.dept ?? "",

      apptype: r.apptype ?? "",
      subtype: r.subtype ?? "",

      result: r.result ?? "",
      all_subj_grade: r.all_subj_grade ?? "",
      conv_grade: r.conv_grade ?? "",

      // hoverì— í•„ìš”í•˜ë©´ ìœ ì§€(ê°œì¸ì •ë³´ ì•„ë‹Œ ë²”ìœ„ì—ì„œë§Œ)
      track: r.track ?? ""
    };
  });

  // ê¸°ì¡´ ìš”ì•½ í†µê³„ë„ ê·¸ëŒ€ë¡œ ìœ ì§€
  const total = safeRecords.length;

  const picked = safeRecords.filter(r => isCapitalByRegion(r.region) || isSpecialUniv(r.univ));
  const passPicked = picked.filter(r => r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©");

  const byUniv = {};
  passPicked.forEach(r => {
    const u = r.univ || "ë¯¸ìƒ";
    byUniv[u] = (byUniv[u] || 0) + 1;
  });

  const capital_special_pass_univ = Object.entries(byUniv)
    .map(([univ, passCount]) => ({ univ, passCount }))
    .sort((a,b) => b.passCount - a.passCount || a.univ.localeCompare(b.univ, "ko"));

  const apptype = {};
  safeRecords.forEach(r => {
    const k = r.apptype || "ë¯¸ìƒ";
    if (!apptype[k]) apptype[k] = { total:0, pass:0, wait:0, fail:0 };
    apptype[k].total += 1;
    if (r.result === "í•©ê²©") apptype[k].pass += 1;
    else if (r.result === "ì¶©ì›í•©ê²©") apptype[k].wait += 1;
    else if (r.result === "ë¶ˆí•©ê²©") apptype[k].fail += 1;
  });

  return {
    meta: {
      createdAt: new Date().toISOString(),
      note: "ê³µìœ ìš© JSON: í•™ìƒ ì´ë¦„ ì œê±°, ìƒë‹´ í™”ë©´ í‘œì‹œëŠ” ë°˜-ë²ˆí˜¸(sid)ë§Œ ì‚¬ìš©"
    },

    // âœ… í•µì‹¬: viewerê°€ ë Œë”í•  ì›ë³¸(ìµëª…í™”) records
    records: safeRecords,

    // ì°¸ê³ ìš© ìš”ì•½
    totalRecords: total,
    apptypeSummary: apptype,
    capitalAndSpecialPassByUniversity: capital_special_pass_univ
  };
}


    
    async function handleGenerate() {
      const file = fileInput.files[0];
      if (!file) {
        setStatus("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", true);
        return;
      }
      setStatus("ì—‘ì…€ì„ ì½ëŠ” ì¤‘...");

      try {
        const records = await parseExcel(file);
        if (!records.length) {
          setStatus("ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„ìˆ˜ ì»¬ëŸ¼ì„ í™•ì¸í•˜ì„¸ìš”.", true);
          return;
        }
        lastRecords = records;
        renderFullReport(records);
        enableJsonExport()
        setStatus(`ì´ ${records.length}ê±´ ë¡œë“œ ì™„ë£Œ. ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } catch (e) {
        console.error(e);
        setStatus("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + e.message, true);
      }
    }

    function parseExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];

            // ì²« 2í–‰ ìŠ¤í‚µ
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 2 });

            // í˜•ì‹ íŒë³„
            const isAltFormat = (() => {
              const cell = sheet["V1"];
              const val = cell ? String(cell.v || "").trim() : "";
              return val.includes("ìµœì¢…ë‹¨ê³„");
            })();

            // ê¸°ë³¸: result=R(17), all_subj=AG(32), conv=AH(33)
            // ëŒ€ì•ˆ: result=V(21), all_subj=R(17), conv=T(19)
            const COL = {
              region: 5,  // F
              univ: 6,    // G
              apptype: 8, // I
              subtype: 10,// K
              dept: 12,   // M
              result: isAltFormat ? 21 : 17,
              all:    isAltFormat ? 17 : 32,
              conv:   isAltFormat ? 19 : 33,
            };

            const records = [];
            rows.forEach((row) => {
              const rawName = safe(row[3]);
              const masked = maskName(rawName);

              const rawUniv = safe(row[COL.univ]);
              const region  = safe(row[COL.region]);

              const rec = {
                grade: safe(row[0]),
                class_no: safe(row[1]),
                student_no: safe(row[2]),
                student_name: masked,          // âœ… ê¸°ë³¸ ë§ˆìŠ¤í‚¹ ì ìš©
                student_name_raw: rawName,     // ë‚´ë¶€ ì°¸ê³ (í‘œì‹œX)
                region,
                univ_raw: rawUniv,
                univ: normalizeUniversityName(rawUniv, region), // âœ… ì¶œë ¥ìš© ë³´ì •ëª…
                apptype: safe(row[COL.apptype]),
                subtype: safe(row[COL.subtype]),
                dept: safe(row[COL.dept]),
                result: normalizeResult(safe(row[COL.result])),
                all_subj_grade: parseGrade(row[COL.all]),
                conv_grade: parseGrade(row[COL.conv]),
              };

              // í•„ìˆ˜ê°’ ì²´í¬
              if (!rec.result || !rec.univ || !rec.dept || !rec.subtype || !rec.apptype) return;
              if (rec.all_subj_grade === null && rec.conv_grade === null) return;

              records.push(rec);
            });

            resolve(records);
          } catch (err) {
            reject(err);
          }
        };

        reader.onerror = (err) => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    function safe(v) {
      return v === undefined || v === null ? "" : String(v).trim();
    }

    function parseGrade(v) {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : null;
    }

    function unique(arr) {
      return Array.from(new Set(arr)).filter(Boolean).sort();
    }

  function normalizeResult(v){
  const s = safe(v);

  // âœ… ë°˜ë“œì‹œ "ë¶ˆí•©ê²©"ì„ ë¨¼ì €
  if (s.includes("ë¶ˆí•©ê²©")) return "ë¶ˆí•©ê²©";
  if (s.includes("ì¶©ì›")) return "ì¶©ì›í•©ê²©";
  if (s.includes("í•©ê²©")) return "í•©ê²©";

  return s;
}


    function maskName(name){
      const s = safe(name);
      if (!s) return "";
      const chars = Array.from(s);
      if (chars.length === 1) return chars[0] + "*";
      if (chars.length === 2) return chars[0] + "*";
      return chars[0] + "*".repeat(chars.length - 2) + chars[chars.length - 1];
    }

    // âœ… ëŒ€í•™ëª… ë³´ì •: (1) ì‚¬ìš©ì ë§¤í•‘ ìš°ì„  (2) (ìº í¼ìŠ¤) ì²«ê¸€ìë§Œ ì¶•ì•½ (3) ì •ë¦¬
    function normalizeUniversityName(univRaw, region){
      const u0 = safe(univRaw);
      if (!u0) return "";

      // 1) ë§¤í•‘ ìš°ì„ (ì™„ì „ì¼ì¹˜)
      if (UNIV_ALIAS_MAP.has(u0)) return UNIV_ALIAS_MAP.get(u0);

      // 2) ê´„í˜¸ ìº í¼ìŠ¤ê°€ ìˆìœ¼ë©´ ì²« ê¸€ìë§Œ
      // ì˜ˆ: "ê³ ë ¤ëŒ€í•™êµ(ì„¸ì¢…)" -> "ê³ ë ¤ëŒ€í•™êµ(ì„¸)"
      // ì˜ˆ: "ë™êµ­ëŒ€í•™êµ(WISE)" -> "ë™êµ­ëŒ€í•™êµ(W)" (ì´ë¯¸ ë§¤í•‘ì´ ì—†ì„ ê²½ìš°)
      let u = u0;

      // í•˜ì´í”ˆ/ìº í¼ìŠ¤ ì„¤ëª… ì œê±° (ëŒ€ëµì ì¸ ì •ë¦¬)
      // " - ê³ ì–‘ìº í¼ìŠ¤" ê°™ì€ ì„¤ëª…ì„ ë–¼ë˜, ê´„í˜¸ëŠ” ë‚¨ê¹€
      u = u.replace(/\s*-\s*.*$/g, "").trim();

      // 3) "êµ­ë¦½" ê°™ì€ ì ‘ë‘ëŠ” ìœ ì§€/ì œê±°ëŠ” ì·¨í–¥ì¸ë°, ì—¬ê¸°ì„  ìœ ì§€(ì‚¬ìš©ì ë§¤í•‘ì— êµ­ë¦½ì´ ì´ë¯¸ ìˆìŒ)
      // 4) ê´„í˜¸ ì²˜ë¦¬
      const m = u.match(/^(.+?)\((.+?)\)$/);
      if (m){
        const head = m[1].trim();
        const inside = m[2].trim();
        const first = Array.from(inside)[0] || "";
        return `${head}(${first})`;
      }

      return u;
    }

    // âœ… ì„œìš¸+ìˆ˜ë„ê¶Œ íŒë‹¨: region ìµœìš°ì„ 
    function isCapitalByRegion(region){
      const r = safe(region);
      return r.includes("ì„œìš¸") || r.includes("ê²½ê¸°") || r.includes("ì¸ì²œ");
    }

    // âœ… íŠ¹ëª©ëŒ€ í¬í•¨ íŒë‹¨(ì¶œë ¥ìš© univ ê¸°ì¤€)
    function isSpecialUniv(univName){
      const u = safe(univName);
      if (!u) return false;
      // aliasë¡œ ì¤„ì—¬ë„ ê±¸ë¦¬ë„ë¡
      if (SPECIAL_UNIVS.has(u)) return true;
      // í”íˆ ì“°ëŠ” í‘œê¸° ëŒ€ì‘
      if (u.includes("ì¹´ì´ìŠ¤íŠ¸") || u.includes("KAIST")) return true;
      if (u.includes("ìœ ë‹ˆìŠ¤íŠ¸") || u.includes("UNIST")) return true;
      if (u.includes("ë””ì§€ìŠ¤íŠ¸") || u.includes("DGIST")) return true;
      if (u.includes("ì§€ìŠ¤íŠ¸") || u.includes("GIST")) return true;
      if (u.includes("ì¼„í…") || u.includes("KENTECH") || u.includes("í•œêµ­ì—ë„ˆì§€ê³µê³¼")) return true;
      // í¬ìŠ¤í… ì œì™¸
      if (u.includes("í¬ìŠ¤í…") || u.includes("POSTECH")) return false;
      return false;
    }

    function renderFullReport(records) {
      plotsData = {};
      plotInitialized = {};
      currentGradeType = "all_subj";

      const univs = unique(records.map((r) => r.univ));
      const depts = unique(records.map((r) => r.dept));
      const apptypes = unique(records.map((r) => r.apptype));
      const subtypes = unique(records.map((r) => r.subtype));

      const header = `
        <div class="fixed-header">
          <div class="header-content">
            <div class="header-top">
              <div class="site-title">modified by KO</div>
            </div>
            <h2 class="university-title">ìˆ˜ì‹œ ì…ì‹œ ê²°ê³¼ í†µê³„ í”„ë¡œê·¸ë¨ [í’ë¬´ê³ ë“±í•™êµ]</h2>

            <div class="controls-legend-wrapper" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
              <div class="grade-toggle-container" style="background:#f1eee7;border:1px solid var(--border);border-radius:12px;padding:10px;">
                <button id="btn-conv" class="grade-toggle-btn">í™˜ì‚°ë“±ê¸‰</button>
                <button id="btn-all" class="grade-toggle-btn active">ì „êµê³¼100 ë“±ê¸‰</button>
              </div>

              <div class="legend-container" style="background:#f1eee7;border:1px solid var(--border);border-radius:12px;padding:10px;">
                <div class="legend-items-wrapper" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                  <div class="legend-item" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="legend-marker" style="font-size:18px;color:#5f8669;">&#9679;</span><span>í•©ê²© (Yì¶• ìƒë‹¨)</span>
                  </div>
                  <div class="legend-item" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="legend-marker" style="font-size:18px;color:#7cab7c;">&#9650;</span><span>ì¶©ì›í•©ê²© (Yì¶• ì¤‘ì•™)</span>
                  </div>
                  <div class="legend-item" style="display:inline-flex;align-items:center;gap:6px;">
                    <span class="legend-marker" style="font-size:18px;color:#d07a5c;">&#10006;</span><span>ë¶ˆí•©ê²© (Yì¶• í•˜ë‹¨)</span>
                  </div>
                </div>
                <div class="axis-label" style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-top:6px;">
                  <span>â†”</span><span id="grade-label">ì „êµê³¼100 ë“±ê¸‰</span> (1~9)
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      const layout = `
        <div class="layout">
          <aside class="toc-container">
            <div class="toc-header" style="font-weight:800;margin-bottom:10px;font-size:16px;">ëª©ì°¨</div>
            <div id="toc-content"></div>
          </aside>
          <main class="main-content" id="content-area"></main>
        </div>
      `;

      reportEl.hidden = false;
      reportEl.innerHTML = header + layout;

      const contentEl = document.getElementById("content-area");
      let plotCounter = 1;

      // ì¶œë ¥ ê¸°ì¤€ í‘œê¸°
      const filterSummary = `
        <div class="dept-container" style="margin-bottom:16px;">
          <div class="print-grade-line">
            ì¶œë ¥ ê¸°ì¤€: <span id="print-grade-text">ì „êµê³¼100 ë“±ê¸‰</span>
          </div>
          ì´ ${records.length}ê±´ Â· ëŒ€í•™ ${univs.length} Â· ëª¨ì§‘ë‹¨ìœ„ ${depts.length} Â· ì „í˜•ìœ í˜• ${apptypes.length} Â· ì „í˜• ${subtypes.length}
        </div>
      `;
      contentEl.insertAdjacentHTML("beforeend", filterSummary);

      // 1) ì „ì²´ ìš”ì•½(í˜„í™©1ë¶€ ì¶œë ¥ ëŒ€ìƒ)
      const overallBlock = buildPlotBlock(records, plotCounter, "ì „ì²´ ë°ì´í„°", true, true, true, true);
      plotsData[plotCounter] = overallBlock.data;

      contentEl.insertAdjacentHTML("beforeend", `
        <div class="dept-container" id="overall-summary">
          <div class="dept-header" style="border-bottom:2px solid #e74c3c;">ì „ì²´ ë°ì´í„° ìš”ì•½</div>
          ${overallBlock.html}
        </div>
      `);
      plotCounter++;

      // 2) ì„œìš¸+ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€ ìš”ì•½(ë³„ë„ ì¶œë ¥)
      const capitalRecords = records.filter(r => isCapitalByRegion(r.region) || isSpecialUniv(r.univ));
      const capitalBlock = buildPlotBlock(capitalRecords, plotCounter, "ì„œìš¸+ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€", true, false, true, true);
      plotsData[plotCounter] = capitalBlock.data;

      contentEl.insertAdjacentHTML("beforeend", `
        <div class="dept-container" id="capital-summary">
          <div class="dept-header" style="border-bottom:2px solid #3498db;">ì„œìš¸+ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€ ìš”ì•½</div>
          <div id="capital-spec-pass-table" style="margin-top:12px;"></div>
          <div style="margin-bottom:10px;color:var(--muted);font-size:13px;">
            * region(ì—‘ì…€ Fì—´) ê¸°ì¤€ìœ¼ë¡œ ì„œìš¸/ê²½ê¸°/ì¸ì²œ í¬í•¨ + íŠ¹ìˆ˜ëª©ì ëŒ€í•™(ì¹´/ìœ /ë””/ì§€/ì¼„í…) í¬í•¨(í¬ìŠ¤í… ì œì™¸)
          </div>
          ${capitalBlock.html}
        </div>
      `);
      plotCounter++;

      // 3) TOP20 (ì „ì²´)
      contentEl.insertAdjacentHTML("beforeend", `
        <div class="dept-container" id="univ-top-global">
          <div class="dept-header">ì§€ì› ìƒìœ„ ëŒ€í•™ TOP 20 í•©/ì¶©ì›/ë¶ˆí•©ê²©</div>
          <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
            <div id="univ-top-chart" class="plot-container" style="height:420px;"></div>
          </div>
        </div>
      `);

      // 4) ëŒ€í•™ë³„ ì„¹ì…˜(ì „ì²´ ì¶œë ¥)
      univs.forEach((univ, uIdx) => {
        const dfUniv = records.filter((r) => r.univ === univ);
        let html = `
          <div class="dept-container" id="univ-${uIdx + 1}">
            <div class="dept-header">${univ}</div>
        `;

        // ì „í˜•ìœ í˜•ë³„ ìš”ì•½
        const apptypesAll = unique(dfUniv.map((r) => r.apptype));
        if (apptypesAll.length) {
          html += `<div style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fff;margin-bottom:14px;">
            <div style="font-weight:700;font-size:17px;margin-bottom:10px;">ì „í˜•ìœ í˜•ë³„ ìš”ì•½</div>`;
          apptypesAll.forEach((ap, aIdx) => {
            const subset = dfUniv.filter((r) => r.apptype === ap);
            const block = buildPlotBlock(subset, plotCounter, `${ap}`, true);
            html += `
              <div style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fefefe;margin:10px 0 0 8px;">
                <div style="font-weight:700;font-size:16px;margin-bottom:8px;">${ap}</div>
                ${block.html}
              </div>
            `;
            plotsData[plotCounter] = block.data;
            plotCounter++;
          });
          html += `</div>`;
        }

        // ì„¸ë¶€ìœ í˜•ë³„ ìš”ì•½
        const subtypesAll = unique(dfUniv.map((r) => r.subtype));
        if (subtypesAll.length) {
          html += `<div style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fff;margin-bottom:14px;">
            <div style="font-weight:700;font-size:17px;margin-bottom:10px;">ì„¸ë¶€ìœ í˜•ë³„ ìš”ì•½</div>`;
          subtypesAll.forEach((st, sIdx) => {
            const subset = dfUniv.filter((r) => r.subtype === st);
            const block = buildPlotBlock(subset, plotCounter, `${st}`, true);
            html += `
              <div style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fefefe;margin:10px 0 0 8px;">
                <div style="font-weight:700;font-size:16px;margin-bottom:8px;">${st}</div>
                ${block.html}
              </div>
            `;
            plotsData[plotCounter] = block.data;
            plotCounter++;
          });
          html += `</div>`;
        }

        // ëª¨ì§‘ë‹¨ìœ„ ìƒì„¸
        const univDepts = unique(dfUniv.map((r) => r.dept));
        univDepts.forEach((dept, dIdx) => {
          const dfDept = dfUniv.filter((r) => r.dept === dept);
          html += `
            <div style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fff;margin-bottom:14px;">
              <div style="font-weight:700;font-size:16px;margin-bottom:10px;color:#34495e;">${dIdx + 1}) ${dept}</div>
          `;

          const deptSubtypes = unique(dfDept.map((r) => r.subtype));
          deptSubtypes.forEach((st, sIdx) => {
            const subset = dfDept.filter((r) => r.subtype === st);
            if (!subset.length) return;
            const block = buildPlotBlock(subset, plotCounter, `${st}`, true);
            html += `
              <div style="border:1px solid #e4ddcf;border-radius:12px;padding:14px;background:#fefefe;margin:10px 0 0 10px;">
                <div style="font-weight:700;font-size:15px;margin-bottom:8px;">${sIdx + 1}) ${st}</div>
                ${block.html}
              </div>
            `;
            plotsData[plotCounter] = block.data;
            plotCounter++;
          });

          html += `</div>`;
        });

        html += `</div>`;
        contentEl.insertAdjacentHTML("beforeend", html);
      });

      bindGradeToggle();
      initPlots();
      buildTOC();
      syncStickyTop();
      renderCapitalAndSpecPassTable(records, { includeWaitlist: true });

    }

    function syncStickyTop() {
      const header = document.querySelector(".fixed-header");
      if (!header) return;
      const h = header.offsetHeight || 0;
      const top = Math.max(160, h + 16);
      document.documentElement.style.setProperty("--stickyTop", top + "px");
    }
    window.addEventListener("resize", syncStickyTop);
  </script>

  <script>
    function buildPlotBlock(dataArr, plotId, title, showStats = true, includeHist = false, includeBands = false, includeApptype = false) {
      const convStats = computeStats(dataArr, "conv_grade");
      const allStats  = computeStats(dataArr, "all_subj_grade");
      const convDetail = computeAdditionalStats(dataArr, "conv_grade");
      const allDetail  = computeAdditionalStats(dataArr, "all_subj_grade");
      const plotData = createPlotData(dataArr);

      const statsHtmlConv = showStats ? createStatsHtml(convStats) : "";
      const statsHtmlAll  = showStats ? createStatsHtml(allStats) : "";
      const detailConv = showStats ? createDetailTable(convDetail, "í™˜ì‚°ë“±ê¸‰") : "";
      const detailAll  = showStats ? createDetailTable(allDetail, "ì „êµê³¼ë“±ê¸‰") : "";

      let extraHtml = "";

      if (includeHist) {
        extraHtml += `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:10px;">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „êµê³¼ë“±ê¸‰ íˆìŠ¤í† ê·¸ë¨</h3>
              <div id="hist-all-${plotId}" class="plot-container" style="height:260px;"></div>
            </div>
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">í™˜ì‚°ë“±ê¸‰ íˆìŠ¤í† ê·¸ë¨</h3>
              <div id="hist-conv-${plotId}" class="plot-container" style="height:260px;"></div>
            </div>
          </div>
        `;
      }

      if (includeBands) {
        extraHtml += `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:10px;">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „êµê³¼ ë“±ê¸‰ëŒ€ë³„ í•©ê²©/ë¶ˆí•©ê²©</h3>
              <div id="band-bar-${plotId}" class="plot-container" style="height:280px;"></div>
            </div>
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ë“±ê¸‰ëŒ€ë³„ í†µê³„</h3>
              <div id="band-table-${plotId}"></div>
            </div>
          </div>
        `;
      }

      if (includeApptype) {
        extraHtml += `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:10px;">
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „í˜•ìœ í˜•ë³„ í•©/ë¶ˆ í˜„í™©</h3>
              <div id="apptype-bar-${plotId}" class="plot-container" style="height:280px;"></div>
            </div>
            <div style="border:1px solid var(--border);border-radius:12px;padding:12px;">
              <h3 style="margin:0 0 8px;font-size:15px;">ì „í˜•ìœ í˜•ë³„ í†µê³„</h3>
              <div id="apptype-table-${plotId}"></div>
            </div>
          </div>
        `;
      }

      const html = `
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div id="conv-stats-${plotId}" style="display:none;flex-wrap:wrap;gap:8px;">${statsHtmlConv}</div>
          <div id="all-stats-${plotId}" style="display:flex;flex-wrap:wrap;gap:8px;">${statsHtmlAll}</div>

          <div class="plot-container" id="plot-${plotId}" style="width:100%;height:220px;"></div>

          <div id="conv-detail-${plotId}" style="display:none;">${detailConv}</div>
          <div id="all-detail-${plotId}" style="display:block;">${detailAll}</div>
          ${extraHtml}
        </div>
      `;

      return { html, data: plotData };
    }

    function createPlotData(dataArr) {
      const studentLabel = (r) => {
        const name = r.student_name || "";
        const g = r.grade || "";
        const c = r.class_no || "";
        const n = r.student_no || "";
        const tail = [g, c, n].filter(Boolean).join("-");
        if (!name && !tail) return "";
        return tail ? `í•™ìƒ: ${name} (${tail})` : `í•™ìƒ: ${name}`;
      };

      const convTraces = RESULT_ORDER.map((res) => {
        const rows = dataArr.filter((r) => r.result === res && r.conv_grade !== null);
        return {
          x: rows.map((r) => r.conv_grade),
          y: rows.map(() => Y_POS[res] ?? 0),
          type: "scatter",
          mode: "markers",
          name: res,
          marker: {
            color: COLOR_MAP[res].fill,
            line: { color: COLOR_MAP[res].border, width: 1.5 },
            symbol: SYMBOL_MAP[res] || "circle",
            size: 12,
          },
          customdata: rows.map((r) => [r.dept, r.subtype, r.univ, r.region, studentLabel(r)]),
          hovertemplate:
            "í™˜ì‚°ë“±ê¸‰: %{x}<br>ëŒ€í•™: %{customdata[2]}<br>ì§€ì—­: %{customdata[3]}<br>ëª¨ì§‘ë‹¨ìœ„: %{customdata[0]}<br>ì „í˜•: %{customdata[1]}<br>%{customdata[4]}<extra></extra>",
          showlegend: false,
        };
      });

      const allTraces = RESULT_ORDER.map((res) => {
        const rows = dataArr.filter((r) => r.result === res && r.all_subj_grade !== null);
        return {
          x: rows.map((r) => r.all_subj_grade),
          y: rows.map(() => Y_POS[res] ?? 0),
          type: "scatter",
          mode: "markers",
          name: res,
          marker: {
            color: COLOR_MAP[res].fill,
            line: { color: COLOR_MAP[res].border, width: 1.5 },
            symbol: SYMBOL_MAP[res] || "circle",
            size: 12,
          },
          customdata: rows.map((r) => [r.dept, r.subtype, r.univ, r.region, studentLabel(r)]),
          hovertemplate:
            "ì „êµê³¼ë“±ê¸‰: %{x}<br>ëŒ€í•™: %{customdata[2]}<br>ì§€ì—­: %{customdata[3]}<br>ëª¨ì§‘ë‹¨ìœ„: %{customdata[0]}<br>ì „í˜•: %{customdata[1]}<br>%{customdata[4]}<extra></extra>",
          showlegend: false,
        };
      });

      return { convTraces, allTraces };
    }

    function createStatsHtml(stats) {
      const items = [];
      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#e4e0d7;border:1px solid #d6cebf;font-size:13px;font-weight:800;">ì´ ${stats.total_count}ê±´</div>`);

      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid var(--primary);">
        í•©ê²©(ì¼ë°˜): ${stats.pass_count}ê±´ (${stats.pass_rate})
      </div>`);

      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid #7cab7c;">
        ì¶©ì›í•©ê²©: ${stats.waitlist_count}ê±´ (${stats.waitlist_rate})
      </div>`);

      const failRate = stats.total_count ? ((stats.fail_count / stats.total_count) * 100).toFixed(1) + "%" : "0.0%";
      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#eef0eb;border:1px solid #d6cebf;font-size:13px;border-left:4px solid #d26c5b;">
        ë¶ˆí•©ê²©: ${stats.fail_count}ê±´ (${failRate})
      </div>`);

      items.push(`<div style="padding:7px 11px;border-radius:8px;background:#f7f7f2;border:1px solid #d6cebf;font-size:13px;">
        í•©ê²©(ì¶©ì›í¬í•¨): ${stats.all_pass_count}ê±´ (${stats.all_pass_rate || "0%"})
      </div>`);

      return items.join("");
    }

    function createDetailTable(detail, title) {
      const rows = RESULT_ORDER.map((res) => {
        const d = detail[res] || {};
        if (!d.count) return `<tr><td>${res}</td><td colspan="6">ë°ì´í„° ì—†ìŒ</td></tr>`;
        return `<tr>
          <td>${res}</td>
          <td>${d.count}</td>
          <td>${fmt(d.mean)}</td>
          <td>${fmt(d.std)}</td>
          <td>${fmt(d.min)} ~ ${fmt(d.max)}</td>
          <td>${fmt(d.median)}</td>
          <td>${fmtRange(d.q1, d.q3)}</td>
        </tr>`;
      }).join("");

      return `
        <div style="border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px;">
          <h3 style="margin:0 0 8px;font-size:15px;">${title} ìƒì„¸ í†µê³„</h3>
          <table class="stats-table">
            <thead>
              <tr>
                <th>ê²°ê³¼</th>
                <th>ê±´ìˆ˜</th>
                <th>í‰ê· </th>
                <th>í‘œì¤€í¸ì°¨</th>
                <th>ë²”ìœ„</th>
                <th>ì¤‘ì•™ê°’</th>
                <th>1Q-3Q</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function computeStats(dataArr, gradeKey) {
      const total = dataArr.length;
      const counts = RESULT_ORDER.reduce((acc, r) => {
        acc[r] = dataArr.filter((d) => d.result === r).length;
        return acc;
      }, {});

      const passData = dataArr
        .filter((d) => d.result === "í•©ê²©" || d.result === "ì¶©ì›í•©ê²©")
        .map((d) => d[gradeKey])
        .filter((v) => v !== null);

      const stats = {
        total_count: total,
        pass_count: counts["í•©ê²©"] || 0,
        waitlist_count: counts["ì¶©ì›í•©ê²©"] || 0,
        fail_count: counts["ë¶ˆí•©ê²©"] || 0,
      };

      stats.all_pass_count = stats.pass_count + stats.waitlist_count;
      stats.pass_rate = total ? ((stats.pass_count / total) * 100).toFixed(1) + "%" : "0.0%";
      stats.waitlist_rate = total ? ((stats.waitlist_count / total) * 100).toFixed(1) + "%" : "0.0%";
      stats.all_pass_rate = total ? ((stats.all_pass_count / total) * 100).toFixed(1) + "%" : "0.0%";

      if (passData.length) {
        stats.all_pass_min = Math.min(...passData);
        stats.all_pass_max = Math.max(...passData);
        stats.all_pass_mean = mean(passData);
      }
      return stats;
    }

    function computeAdditionalStats(dataArr, key) {
      const out = {};
      RESULT_ORDER.forEach((res) => {
        const arr = dataArr.filter((d) => d.result === res).map((d) => d[key]).filter((v) => v !== null);
        if (!arr.length) { out[res] = { count: 0 }; return; }
        out[res] = {
          count: arr.length,
          mean: mean(arr),
          std: stddev(arr),
          min: Math.min(...arr),
          max: Math.max(...arr),
          median: percentile(arr, 50),
          q1: percentile(arr, 25),
          q3: percentile(arr, 75),
        };
      });
      return out;
    }

    function mean(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }
    function stddev(arr) {
      if (arr.length < 2) return 0;
      const m = mean(arr);
      return Math.sqrt(arr.reduce((s, v) => s + Math.pow(v - m, 2), 0) / (arr.length - 1));
    }
    function percentile(arr, p) {
      if (!arr.length) return 0;
      const s = [...arr].sort((a, b) => a - b);
      const rank = (p / 100) * (s.length - 1);
      const l = Math.floor(rank);
      const h = Math.ceil(rank);
      if (l === h) return s[l];
      const w = rank - l;
      return s[l] * (1 - w) + s[h] * w;
    }
    function fmt(v) { return v === undefined || v === null || Number.isNaN(v) ? "-" : Number(v).toFixed(2); }
    function fmtRange(a, b) { if ([a, b].some((x) => x === undefined || x === null || Number.isNaN(x))) return "-"; return `${Number(a).toFixed(2)} ~ ${Number(b).toFixed(2)}`; }

    function createLayout() {
      return {
        height: 220,
        autosize: true,
        margin: { t: 12, b: 45, l: 55, r: 25 },
        xaxis: {
          range: [0.5, 9.5],
          tickmode: "array",
          tickvals: [1,2,3,4,5,6,7,8,9],
          ticktext: ["1","2","3","4","5","6","7","8","9"],
          title: "ë“±ê¸‰"
        },
        yaxis: {
          range: [-0.05, 0.05],
          tickmode: "array",
          tickvals: [0.01, 0.0, -0.03],
          ticktext: ["", "", ""],
          showgrid: false,
          zeroline: false
        },
        showlegend: false,
        plot_bgcolor: "#fff",
        paper_bgcolor: "#fff",
      };
    }

    function initPlots() {
      document.querySelectorAll(".plot-container[id^='plot-']").forEach((div) => {
        const id = div.id.split("-")[1];
        const data = plotsData[id];
        if (!data) return;
        const traces = currentGradeType === "conv" ? data.convTraces : data.allTraces;
        Plotly.newPlot(div, traces, createLayout(), { displayModeBar: false, responsive: true });
        plotInitialized[id] = true;
      });

      Object.keys(plotsData).forEach((pid) => {
        if (document.getElementById(`hist-all-${pid}`)) renderHist(lastRecords, "all_subj_grade", `hist-all-${pid}`, "ì „êµê³¼ë“±ê¸‰");
        if (document.getElementById(`hist-conv-${pid}`)) renderHist(lastRecords, "conv_grade", `hist-conv-${pid}`, "í™˜ì‚°ë“±ê¸‰");
        if (document.getElementById(`band-bar-${pid}`)) renderGradeBands(lastRecords, "all_subj_grade", pid);
        if (document.getElementById(`apptype-bar-${pid}`)) renderApptypeStats(lastRecords, pid);
      });

      renderUnivTop(lastRecords);
    }
//ë‚´ê°€ ë„£ì€ ì½”ë“œ
// âœ… ëŒ€í•™ëª… ë³´ì •(ë„ˆê°€ ì¤€ ê·œì¹™ ë°˜ì˜)
function normalizeUnivName(name) {
  const raw = (name || "").trim();
  if (!raw) return "";

  const MAP = {
    "êµ­ë¦½í•œêµ­í•´ì–‘ëŒ€í•™êµ(ë¶€ì‚°)": "í•œêµ­í•´ì–‘ëŒ€",
    "í•œì–‘ëŒ€í•™êµ(ERICA)": "í•œì–‘ëŒ€(ì—)",
    "ê´‘ì£¼ì—¬ìëŒ€í•™êµ(ê´‘ì£¼)": "ê´‘ì£¼ì—¬ëŒ€",
    "ì¤‘ë¶€ëŒ€í•™êµ(ê³ ì–‘) - ê³ ì–‘ìº í¼ìŠ¤": "ì¤‘ë¶€ëŒ€",
    "ì¤‘ë¶€ëŒ€í•™êµ(ê¸ˆì‚°) - ì¶©ì²­ìº í¼ìŠ¤": "ì¤‘ë¶€ëŒ€",
    "ë™êµ­ëŒ€í•™êµ(WISE)": "ë™êµ­ëŒ€(W)",
    "ì¤‘ì•™ëŒ€í•™êµ(ë‹¤ë¹ˆì¹˜)": "ì¤‘ì•™ëŒ€(ë‹¤)",
    "ê±´êµ­ëŒ€í•™êµ(ê¸€ë¡œì»¬)": "ê±´êµ­ëŒ€(ê¸€)",
    "ìƒëª…ëŒ€í•™êµ(ì²œì•ˆ)": "ìƒëª…ëŒ€(ì²œ)",
    "í•œêµ­ê¸°ìˆ êµìœ¡ëŒ€í•™êµ(ì²œì•ˆ)": "í•œêµ­ê¸°ìˆ êµëŒ€",
    "í•œêµ­í•­ê³µëŒ€í•™êµ(ê³ ì–‘)": "í•œêµ­í•­ê³µëŒ€",
    "í™ìµëŒ€í•™êµ(ì„¸ì¢…)": "í™ìµëŒ€(ì„¸)"
  };

  if (MAP[raw]) return MAP[raw];

  // âœ… "ì„œìš¸ì§€ì—­ê³¼ ë™ì¼í•œ ëª…ì¹­ì˜ ì§€ë°©ìº í¼ìŠ¤" ê·œì¹™:
  // ê´„í˜¸ê°€ ìˆìœ¼ë©´ ê´„í˜¸ ì•ˆ ì²« ê¸€ìë§Œ í‘œê¸° (ì˜ˆ: ê³ ë ¤ëŒ€í•™êµ(ì„¸ì¢…) -> ê³ ë ¤ëŒ€(ì„¸))
  // ë‹¨, ì´ë¯¸ (ì—)/(W)/(ë‹¤)/(ê¸€)/(ì²œ)/(ì„¸) ë“±ìœ¼ë¡œ ë³´ì •ëœ ì¼€ì´ìŠ¤ëŠ” ìœ„ MAPì—ì„œ ì²˜ë¦¬ë¨.
  const m = raw.match(/^(.*)\((.+)\)$/);
  if (m) {
    const base = m[1].trim();
    const inside = (m[2] || "").trim();
    const firstChar = inside ? inside[0] : "";
    // baseê°€ ë„ˆë¬´ ê¸¸ë©´ í”íˆ ì“°ëŠ” ì•½ì¹­ìœ¼ë¡œ ì¤„ì´ëŠ” ê±´ í•™êµë§ˆë‹¤ ë‹¬ë¼ì„œ ì—¬ê¸°ì„œëŠ” ê·¸ëŒ€ë¡œ ë‘ 
    return firstChar ? `${base.replace(/ëŒ€í•™êµ$/, "ëŒ€")}(${firstChar})` : base.replace(/ëŒ€í•™êµ$/, "ëŒ€");
  }

  return raw.replace(/ëŒ€í•™êµ$/, "ëŒ€");
}

// âœ… ìˆ˜ë„ê¶Œ/íŠ¹ëª©ëŒ€ íŒì • + í‘œ ë Œë”ë§
function renderCapitalAndSpecPassTable(records, options = {}) {
  const host = document.getElementById("capital-spec-pass-table");
  if (!host) return;

  const includeWaitlist = !!options.includeWaitlist; // falseë©´ 'í•©ê²©'ë§Œ
  const topN = options.topN || 0; // 0ì´ë©´ ì „ì²´, 20ì´ë©´ ìƒìœ„20ë§Œ

  // 1) ìˆ˜ë„ê¶Œ(region ìµœìš°ì„ )
  const isCapitalByRegion = (region) => ["ì„œìš¸", "ê²½ê¸°", "ì¸ì²œ"].includes((region || "").trim());

  // 2) íŠ¹ëª©ëŒ€(í¬ìŠ¤í… ì œì™¸, ì¼„í… í¬í•¨)
  //    âš ï¸ ì—¬ê¸° ì´ë¦„ì€ normalizeUnivName() ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ëŠ” ê²Œ ì•ˆì „í•¨
  const SPECIAL_UNIVS = new Set([
    "KAIST", "ì¹´ì´ìŠ¤íŠ¸",
    "UNIST", "ìœ ë‹ˆìŠ¤íŠ¸",
    "DGIST", "ë””ì§€ìŠ¤íŠ¸",
    "GIST", "ì§€ìŠ¤íŠ¸",
    "í•œêµ­ì—ë„ˆì§€ê³µê³¼ëŒ€í•™êµ", "ì¼„í…", "KENTECH"
  ]);

  const isSpecial = (univNormalized) => SPECIAL_UNIVS.has(univNormalized);

  // âœ… ëŒ€ìƒ ì¶”ì¶œ: ìˆ˜ë„ê¶Œ + íŠ¹ëª©ëŒ€
  const picked = records.filter(r => {
    const uNorm = normalizeUnivName(r.univ);
    const capital = isCapitalByRegion(r.region);
    const spec = isSpecial(uNorm);
    return capital || spec;
  });

  // âœ… í•©ê²© ì§‘ê³„ (ì˜µì…˜ì— ë”°ë¼ ì¶©ì› í¬í•¨ ê°€ëŠ¥)
  const isPass = (r) => {
    if (includeWaitlist) return (r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©");
    return r.result === "í•©ê²©";
  };

  const map = new Map(); // univ -> count
  picked.filter(isPass).forEach(r => {
    const uNorm = normalizeUnivName(r.univ) || "ë¯¸ìƒ";
    map.set(uNorm, (map.get(uNorm) || 0) + 1);
  });

  let rows = Array.from(map.entries())
    .map(([univ, cnt]) => ({ univ, cnt }))
    .sort((a, b) => b.cnt - a.cnt || a.univ.localeCompare(b.univ, "ko"));

  if (topN > 0) rows = rows.slice(0, topN);

  if (!rows.length) {
    host.innerHTML = `<div class="empty">ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€ â€˜í•©ê²©â€™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  host.innerHTML = `
    <div style="border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;margin-bottom:10px;flex-wrap:wrap;">
        <div style="font-weight:800;font-size:16px;">ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€ ëŒ€í•™ë³„ í•©ê²© ì¸ì›</div>
        <div style="color:var(--muted);font-size:12px;">
          ê¸°ì¤€: region=ì„œìš¸/ê²½ê¸°/ì¸ì²œ + íŠ¹ëª©ëŒ€(í¬ìŠ¤í… ì œì™¸, ì¼„í… í¬í•¨) Â· ê²°ê³¼=${includeWaitlist ? "í•©ê²©+ì¶©ì›í•©ê²©" : "í•©ê²©"}
        </div>
      </div>

      <table class="stats-table">
        <thead>
          <tr>
            <th style="width:56px;">ìˆœìœ„</th>
            <th>ëŒ€í•™</th>
            <th style="width:120px;">í•©ê²© ì¸ì›</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r, i) => `
            <tr>
              <td>${i + 1}</td>
              <td style="text-align:left;padding-left:10px;">${r.univ}</td>
              <td style="font-weight:800;">${r.cnt}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}


//ì—¬ê¸°ê¹Œì§€    
    function updateAllPlots() {
      document.querySelectorAll(".plot-container[id^='plot-']").forEach((div) => {
        const id = div.id.split("-")[1];
        const data = plotsData[id];
        if (!data || !plotInitialized[id]) return;
        const traces = currentGradeType === "conv" ? data.convTraces : data.allTraces;
        Plotly.react(div, traces, createLayout(), { displayModeBar: false, responsive: true });
      });
    }

    function bindGradeToggle() {
      const btnConv = document.getElementById("btn-conv");
      const btnAll  = document.getElementById("btn-all");
      btnConv.onclick = () => switchGrade("conv");
      btnAll.onclick  = () => switchGrade("all_subj");
    }

    function switchGrade(type) {
      if (currentGradeType === type) return;
      currentGradeType = type;

      document.getElementById("btn-conv").classList.toggle("active", type === "conv");
      document.getElementById("btn-all").classList.toggle("active", type === "all_subj");

      document.getElementById("grade-label").textContent = type === "conv" ? "í™˜ì‚°ë“±ê¸‰" : "ì „êµê³¼100 ë“±ê¸‰";
      const pg = document.getElementById("print-grade-text");
      if (pg) pg.textContent = type === "conv" ? "í™˜ì‚°ë“±ê¸‰" : "ì „êµê³¼100 ë“±ê¸‰";

      document.querySelectorAll("[id^='conv-stats-']").forEach((el) => el.style.display = type === "conv" ? "flex" : "none");
      document.querySelectorAll("[id^='all-stats-']").forEach((el)  => el.style.display = type === "all_subj" ? "flex" : "none");
      document.querySelectorAll("[id^='conv-detail-']").forEach((el)=> el.style.display = type === "conv" ? "block" : "none");
      document.querySelectorAll("[id^='all-detail-']").forEach((el) => el.style.display = type === "all_subj" ? "block" : "none");

      updateAllPlots();
    }

    // âœ… ëª©ì°¨: í° ì„¹ì…˜ë§Œ ì¡ì•„ë„ ì¶©ë¶„íˆ ì•ˆì •ì 
    function buildTOC() {
      const toc = document.getElementById("toc-content");
      const items = [];

      const pushItem = (id, label) => {
        if (document.getElementById(id)) items.push({id,label});
      };

      pushItem("overall-summary", "ì „ì²´ ë°ì´í„° ìš”ì•½");
      pushItem("capital-summary", "ì„œìš¸+ìˆ˜ë„ê¶Œ+íŠ¹ëª©ëŒ€ ìš”ì•½");
      pushItem("univ-top-global", "ì§€ì› TOP20");

      document.querySelectorAll("[id^='univ-']").forEach((el) => {
        const header = el.querySelector(".dept-header");
        if (!header) return;
        items.push({ id: el.id, label: header.textContent });
      });

      toc.innerHTML = items.map(it =>
        `<div style="font-weight:700;cursor:pointer;padding:6px;border-radius:8px;color:var(--primary-dark);" onclick="scrollToElement('${it.id}')">${it.label}</div>`
      ).join("");
    }

    function scrollToElement(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const headerHeight = document.querySelector(".fixed-header")?.offsetHeight || 0;
      const top = el.getBoundingClientRect().top + window.pageYOffset - headerHeight - 10;
      window.scrollTo({ top, behavior: "smooth" });
    }
    window.scrollToElement = scrollToElement;

    function makeHistogramSeries(records, key) {
      const passArr = records.filter((r) => r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©").map((r) => r[key]).filter((v) => v !== null);
      const failArr = records.filter((r) => r.result === "ë¶ˆí•©ê²©").map((r) => r[key]).filter((v) => v !== null);
      const edges = [];
      for (let v = BINS.start; v < BINS.end; v += BINS.size) edges.push(Number(v.toFixed(4)));
      edges.push(BINS.end);
      const bins = edges.length - 1;
      const passCounts = new Array(bins).fill(0);
      const failCounts = new Array(bins).fill(0);
      const center = [];
      for (let i = 0; i < bins; i++) center.push((edges[i] + edges[i + 1]) / 2);

      const fillCounts = (arr, target) => {
        arr.forEach((v) => {
          if (v < BINS.start || v > BINS.end) return;
          const idx = Math.min(Math.floor((v - BINS.start) / BINS.size), bins - 1);
          target[idx] += 1;
        });
      };
      fillCounts(passArr, passCounts);
      fillCounts(failArr, failCounts);
      return { center, passCounts, failCounts };
    }

    function makeGradeBandStats(records, key) {
      const bands = [
        { label: "1ë“±ê¸‰ëŒ€", from: 1, to: 1.999 },
        { label: "2ë“±ê¸‰ëŒ€", from: 2, to: 2.999 },
        { label: "3ë“±ê¸‰ëŒ€", from: 3, to: 3.999 },
        { label: "4ë“±ê¸‰ëŒ€", from: 4, to: 4.999 },
        { label: "5ë“±ê¸‰ëŒ€", from: 5, to: 5.999 },
        { label: "6ë“±ê¸‰ëŒ€", from: 6, to: 6.999 },
        { label: "7ë“±ê¸‰ëŒ€", from: 7, to: 7.999 },
        { label: "8ë“±ê¸‰ëŒ€", from: 8, to: 8.999 },
        { label: "9ë“±ê¸‰ëŒ€", from: 9, to: 9.999 },
      ];
      return bands.map((b) => {
        const inBand = records.filter((r) => r[key] !== null && r[key] >= b.from && r[key] <= b.to);
        const pass = inBand.filter((r) => r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©").length;
        const fail = inBand.filter((r) => r.result === "ë¶ˆí•©ê²©").length;
        const total = pass + fail;
        return { label: b.label, pass, fail, total, passRate: total ? (pass / total) * 100 : 0 };
      });
    }

    function renderGradeBands(records, key, targetPlotId) {
      const stats = makeGradeBandStats(records, key);
      const labels = stats.map((s) => s.label);
      const passCounts = stats.map((s) => s.pass);
      const failCounts = stats.map((s) => s.fail);
      const hasData = stats.some((s) => s.total > 0);

      const barEl = document.getElementById(`band-bar-${targetPlotId}`);
      const tableEl = document.getElementById(`band-table-${targetPlotId}`);

      if (barEl) {
        if (!hasData) {
          barEl.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          Plotly.newPlot(barEl, [
            { x: labels, y: passCounts, type: "bar", name: "í•©ê²©(ì¶©ì›í¬í•¨)", marker: { color: COLOR_MAP["í•©ê²©"].border } },
            { x: labels, y: failCounts, type: "bar", name: "ë¶ˆí•©ê²©", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border } },
          ], {
            height: 280,
            barmode: "stack",
            margin: { t: 20, b: 40, l: 45, r: 20 },
            yaxis: { title: "ì¸ì›" },
          }, { displayModeBar: false, responsive: true });
        }
      }

      if (tableEl) {
        const rows = stats.map((s) => {
          if (!s.total) return `<tr><td>${s.label}</td><td colspan="4">ë°ì´í„° ì—†ìŒ</td></tr>`;
          return `<tr>
            <td>${s.label}</td>
            <td>${s.pass}</td>
            <td>${s.fail}</td>
            <td>${s.total}</td>
            <td>${s.passRate.toFixed(1)}%</td>
          </tr>`;
        }).join("");

        tableEl.innerHTML = `
          <table class="stats-table">
            <thead><tr><th>ë“±ê¸‰ëŒ€</th><th>í•©ê²©</th><th>ë¶ˆí•©ê²©</th><th>ì´ì›</th><th>í•©ê²©ë¥ </th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    }

    function makeApptypeStats(records) {
      const groups = {};
      records.forEach((r) => {
        const key = r.apptype || "ë¯¸ìƒ";
        if (!groups[key]) groups[key] = { total: 0, pass: 0, wait: 0, fail: 0 };
        groups[key].total += 1;
        if (r.result === "í•©ê²©") groups[key].pass += 1;
        else if (r.result === "ì¶©ì›í•©ê²©") groups[key].wait += 1;
        else if (r.result === "ë¶ˆí•©ê²©") groups[key].fail += 1;
      });
      return Object.entries(groups).map(([apptype, g]) => {
        const total = g.total || 1;
        return {
          apptype, total: g.total, pass: g.pass, wait: g.wait, fail: g.fail,
          passRate: (g.pass / total) * 100,
          waitRate: (g.wait / total) * 100,
          failRate: (g.fail / total) * 100,
        };
      }).sort((a, b) => b.total - a.total);
    }

    function renderApptypeStats(records, plotId) {
      const stats = makeApptypeStats(records);
      const labels = stats.map((s) => s.apptype);
      const passCounts = stats.map((s) => s.pass);
      const waitCounts = stats.map((s) => s.wait);
      const failCounts = stats.map((s) => s.fail);
      const hasData = stats.some((s) => s.total > 0);

      const barEl = document.getElementById(`apptype-bar-${plotId}`);
      const tableEl = document.getElementById(`apptype-table-${plotId}`);

      if (barEl) {
        if (!hasData) {
          barEl.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          Plotly.newPlot(barEl, [
            { y: labels, x: passCounts, type: "bar", name: "í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["í•©ê²©"].border } },
            { y: labels, x: waitCounts, type: "bar", name: "ì¶©ì›í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ì¶©ì›í•©ê²©"].border } },
            { y: labels, x: failCounts, type: "bar", name: "ë¶ˆí•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border } },
          ], {
            height: Math.max(240, 26 * labels.length + 80),
            barmode: "stack",
            margin: { t: 20, b: 40, l: 120, r: 20 },
            xaxis: { title: "ì¸ì›" },
          }, { displayModeBar: false, responsive: true });
        }
      }

      if (tableEl) {
        const rows = stats.map((s) => {
          if (!s.total) return `<tr><td>${s.apptype}</td><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>`;
          return `<tr>
            <td>${s.apptype}</td>
            <td>${s.total}</td>
            <td>${s.pass}</td>
            <td>${s.wait}</td>
            <td>${s.fail}</td>
            <td>${s.passRate.toFixed(1)}%</td>
            <td>${s.waitRate.toFixed(1)}%</td>
            <td>${s.failRate.toFixed(1)}%</td>
          </tr>`;
        }).join("");

        tableEl.innerHTML = `
          <table class="stats-table">
            <thead><tr><th>ì „í˜•ìœ í˜•</th><th>ì´ì›</th><th>í•©ê²©</th><th>ì¶©ì›</th><th>ë¶ˆí•©ê²©</th><th>í•©ê²©ë¥ </th><th>ì¶©ì›ë¥ </th><th>ë¶ˆí•©ê²©ë¥ </th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    }

    function renderUnivTop(records) {
      const univTopEl = document.getElementById("univ-top-chart");
      if (!univTopEl) return;

      const grouped = {};
      records.forEach((r) => {
        const key = r.univ || "ë¯¸ìƒ";
        if (!grouped[key]) grouped[key] = { pass: 0, wait: 0, fail: 0, total: 0 };
        grouped[key].total += 1;
        if (r.result === "í•©ê²©") grouped[key].pass += 1;
        else if (r.result === "ì¶©ì›í•©ê²©") grouped[key].wait += 1;
        else if (r.result === "ë¶ˆí•©ê²©") grouped[key].fail += 1;
      });

      const sorted = Object.entries(grouped)
        .map(([univ, g]) => ({ univ, ...g }))
        .filter((x) => x.total > 0)
        .sort((a, b) => b.total - a.total)
        .slice(0, 20);

      const labelsTop = sorted.map((s) => s.univ);
      const passTop = sorted.map((s) => s.pass);
      const waitTop = sorted.map((s) => s.wait);
      const failTop = sorted.map((s) => s.fail);

      if (!sorted.length) {
        univTopEl.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
      } else {
        const dynamicHeight = Math.max(360, 26 * labelsTop.length + 110);
        univTopEl.style.height = dynamicHeight + "px";
        Plotly.newPlot(univTopEl, [
          { y: labelsTop, x: passTop, type: "bar", name: "í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["í•©ê²©"].border } },
          { y: labelsTop, x: waitTop, type: "bar", name: "ì¶©ì›í•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ì¶©ì›í•©ê²©"].border } },
          { y: labelsTop, x: failTop, type: "bar", name: "ë¶ˆí•©ê²©", orientation: "h", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border } },
        ], {
          height: dynamicHeight,
          barmode: "stack",
          margin: { t: 24, b: 40, l: 150, r: 24 },
          xaxis: { title: "ì¸ì›" },
        }, { displayModeBar: false, responsive: true });
      }
    }

    function renderHist(records, key, targetId, title) {
      const el = document.getElementById(targetId);
      if (!el) return;

      const { center, passCounts, failCounts } = makeHistogramSeries(records, key);
      const hasData = passCounts.some((c) => c > 0) || failCounts.some((c) => c > 0);

      if (!hasData) { el.innerHTML = '<div class="empty">ë°ì´í„° ì—†ìŒ</div>'; return; }

      const maxVal = Math.max(...passCounts, ...failCounts, 0);
      const traces = [
        {
          x: center, y: passCounts, type: "bar",
          name: "í•©ê²©(ì¶©ì›í¬í•¨)", marker: { color: COLOR_MAP["í•©ê²©"].border },
          width: BINS.size * 0.9,
        },
        {
          x: center, y: failCounts.map((v) => -v), type: "bar",
          name: "ë¶ˆí•©ê²©", marker: { color: COLOR_MAP["ë¶ˆí•©ê²©"].border },
          width: BINS.size * 0.9,
        },
      ];
      Plotly.newPlot(el, traces, {
        height: 260,
        barmode: "relative",
        bargap: 0.02,
        margin: { t: 20, b: 45, l: 50, r: 20 },
        xaxis: { title: "ë“±ê¸‰", range: [BINS.start, BINS.end] },
        yaxis: { title: "ì¸ì›(+í•©ê²© / -ë¶ˆí•©ê²©)", zeroline: true, range: [-maxVal * 1.2, maxVal * 1.2] },
      }, { displayModeBar: false, responsive: true });
    }
    // ===== ê³µìœ ìš© JSON ë‚´ë³´ë‚´ê¸° =====
let shareExportReady = false;

function enableJsonExport() {
  const btn = document.getElementById("json-btn");
  if (!btn) return;
  btn.disabled = false;
  shareExportReady = true;
}

document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "json-btn") {
    exportShareJson();
  }
});

function exportShareJson() {
  if (!shareExportReady || !lastRecords || !lastRecords.length) {
    alert("ë¨¼ì € ë³´ê³ ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!");
    return;
  }

  // âœ… ì—¬ê¸°ì„œ lastRecordsë¥¼ â€œê°œì¸ì •ë³´ ì—†ëŠ” ìš”ì•½â€ìœ¼ë¡œ ë°”ê¿”ì„œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
  // ìˆ˜ë„ê¶Œ/íŠ¹ëª©ëŒ€ í•©ê²©ì¸ì›(ëŒ€í•™ë³„)ë§Œ í¬í•¨ (ìµœì†Œ ê³µìœ  ë‹¨ìœ„)
  const { metroPassByUniv, spUnivPassByUniv } = buildPassTablesForShare(lastRecords);

  const payload = {
    generatedAt: new Date().toISOString(),
    tables: {
      metroPassByUniv,
      spUnivPassByUniv
    }
  };

  downloadJson(payload, "share.json");
  try {
  const result = await uploadShareToDrive(payload);
  alert("Driveì— ê³µìœ  íŒŒì¼ ì €ì¥ ì™„ë£Œ\n" + result.meta.updatedAt);
} catch (e) {
  alert("ê³µìœ  íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
}

}
async function uploadShareToDrive(payload) {
  const res = await fetch(WEBAPP_URL + "?action=save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!json.ok) {
    throw new Error(json.message || "ì—…ë¡œë“œ ì‹¤íŒ¨");
  }
  return json;
}

function downloadJson(obj, fileName) {
  const text = JSON.stringify(obj, null, 2);
  const blob = new Blob([text], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/**
 * âœ… â€œì—‘ì…€ region ìµœìš°ì„ â€ ì›ì¹™ì„ ì¡´ì¤‘:
 * - ìˆ˜ë„ê¶Œ íŒì •ì€ region ê°’ì´ ìˆìœ¼ë©´ regionìœ¼ë¡œ, ì—†ìœ¼ë©´ ëŒ€í•™ëª… ë³´ì • ê·œì¹™ìœ¼ë¡œ.
 * - íŠ¹ëª©ëŒ€ëŠ” ë³„ë„ ì§‘ê³„(ìˆ˜ë„ê¶Œ í‘œì—ë„ ê°™ì´ ë‚˜ì˜¤ê²Œ í•˜ê³  ì‹¶ìœ¼ë©´ í•©ì¹  ìˆ˜ë„ ìˆìŒ)
 *
 * ì•„ë˜ êµ¬í˜„ì€ â€œregion ê¸°ë°˜ + ë³´ì •ëœ ëŒ€í•™ëª… ê¸°ë°˜â€ì„ ê°™ì´ ì”ë‹ˆë‹¤.
 */
function buildPassTablesForShare(records) {
  // í•©ê²©(ì¶©ì› í¬í•¨)ë§Œ
  const passRows = records.filter(r => r.result === "í•©ê²©" || r.result === "ì¶©ì›í•©ê²©");

  // 1) ëŒ€í•™ëª… ë³´ì •(ì‚¬ìš©ì ë£° ë°˜ì˜: () ì²«ê¸€ìë§Œ ë“±)
  //    â€» ì´ í•¨ìˆ˜ëŠ” â€œì¶œë ¥/ê³µìœ ìš©â€ì—ì„œë§Œ ì“°ë¼ê³  í•˜ì…¨ìœ¼ë‹ˆ ì—¬ê¸°ì„œë§Œ ì ìš©
  const normalizeUniv = (name) => {
    let s = String(name || "").trim();
    if (!s) return s;

    // ì‚¬ìš©ìê°€ ì¤€ ëŒ€í‘œ ì¹˜í™˜
    const map = new Map([
      ["êµ­ë¦½í•œêµ­í•´ì–‘ëŒ€í•™êµ(ë¶€ì‚°)", "í•œêµ­í•´ì–‘ëŒ€"],
      ["í•œì–‘ëŒ€í•™êµ(ERICA)", "í•œì–‘ëŒ€(ì—)"],
      ["ê´‘ì£¼ì—¬ìëŒ€í•™êµ(ê´‘ì£¼)", "ê´‘ì£¼ì—¬ëŒ€"],
      ["ì¤‘ë¶€ëŒ€í•™êµ(ê³ ì–‘) - ê³ ì–‘ìº í¼ìŠ¤", "ì¤‘ë¶€ëŒ€"],
      ["ì¤‘ë¶€ëŒ€í•™êµ(ê¸ˆì‚°) - ì¶©ì²­ìº í¼ìŠ¤", "ì¤‘ë¶€ëŒ€"],
      ["ë™êµ­ëŒ€í•™êµ(WISE)", "ë™êµ­ëŒ€(W)"],
      ["ì¤‘ì•™ëŒ€í•™êµ(ë‹¤ë¹ˆì¹˜)", "ì¤‘ì•™ëŒ€(ë‹¤)"],
      ["ê±´êµ­ëŒ€í•™êµ(ê¸€ë¡œì»¬)", "ê±´êµ­ëŒ€(ê¸€)"],
      ["ìƒëª…ëŒ€í•™êµ(ì²œì•ˆ)", "ìƒëª…ëŒ€(ì²œ)"],
      ["í•œêµ­ê¸°ìˆ êµìœ¡ëŒ€í•™êµ(ì²œì•ˆ)", "í•œêµ­ê¸°ìˆ êµëŒ€"],
      ["í•œêµ­í•­ê³µëŒ€í•™êµ(ê³ ì–‘)", "í•œêµ­í•­ê³µëŒ€"],
      ["í™ìµëŒ€í•™êµ(ì„¸ì¢…)", "í™ìµëŒ€(ì„¸)"],
    ]);
    if (map.has(s)) return map.get(s);

    // â€œì„œìš¸ì§€ì—­ê³¼ ë™ì¼í•œ ëª…ì¹­ìœ¼ë¡œ ìš´ì˜í•˜ëŠ” ì§€ë°©ëŒ€ â†’ () ì²«ê¸€ìë§Œâ€
    // ì˜ˆ: ê³ ë ¤ëŒ€í•™êµ(ì„¸ì¢…) -> ê³ ë ¤ëŒ€(ì„¸)
    //     ì¤‘ì•™ëŒ€í•™êµ(ë‹¤ë¹ˆì¹˜) ê°™ì€ ì¼€ì´ìŠ¤ë„ ë™ì¼ ì²˜ë¦¬ ê°€ëŠ¥
    // 1) ê´„í˜¸í˜•: (ì„¸ì¢…)
    const m1 = s.match(/^(.+?)\((.+?)\)\s*$/);
    if (m1) {
      const base = m1[1].trim();
      const campus = m1[2].trim();
      const first = campus ? campus[0] : "";
      return first ? `${shortenBase(base)}(${first})` : shortenBase(base);
    }

    // 2) í•˜ì´í”ˆí˜•: " - ì„¸ì¢…ìº í¼ìŠ¤" ê°™ì€ í‘œí˜„ (ì´ë¯¸ mapì— ì¼ë¶€ ìˆì§€ë§Œ ì¼ë°˜í™”)
    //    ex) "í™ìµëŒ€í•™êµ - ì„¸ì¢…ìº í¼ìŠ¤" -> í™ìµëŒ€(ì„¸)
    const m2 = s.match(/^(.+?)\s*-\s*(.+?)ìº í¼ìŠ¤\s*$/);
    if (m2) {
      const base = m2[1].trim();
      const campus = m2[2].trim();
      const first = campus ? campus[0] : "";
      return first ? `${shortenBase(base)}(${first})` : shortenBase(base);
    }

    // ê¸°ë³¸ ì¶•ì•½: "ëŒ€í•™êµ" ë“± ì œê±°ëŠ” ì›í•˜ë©´ ë” ê°•í™” ê°€ëŠ¥
    return shortenBase(s);
  };

  function shortenBase(base) {
    // ë„ˆë¬´ ê³¼ê²©í•˜ê²Œ ì¤„ì´ë©´ ë™ëª…ì´êµ ìœ„í—˜ â†’ â€œëŒ€í•™êµâ€â†’â€œëŒ€â€ ì •ë„ë§Œ
    return base.replace(/ëŒ€í•™êµ$/,"ëŒ€").replace(/êµ­ë¦½$/,"");
  }

  // 2) ìˆ˜ë„ê¶Œ íŒì •: region ìš°ì„ 
  const isMetroByRegion = (region) => {
    const r = String(region||"").trim();
    if (!r) return null; // region ì—†ìœ¼ë©´ ë¯¸íŒì •
    // ìˆ˜ë„ê¶Œ: ì„œìš¸/ê²½ê¸°/ì¸ì²œ
    return (r.includes("ì„œìš¸") || r.includes("ê²½ê¸°") || r.includes("ì¸ì²œ"));
  };

  // 3) íŠ¹ëª©ëŒ€ ëª©ë¡ (í¬ìŠ¤í… ì œì™¸, ì¼„í… í¬í•¨)
  //   - ì‹¤ì œ ë°ì´í„° â€œëŒ€í•™ëª…â€ì´ ì–´ë–¤ ë¬¸ìì—´ì¸ì§€ì— ë”°ë¼ normalize í›„ ë¹„êµí•©ë‹ˆë‹¤.
  const SP_SET = new Set([
    "KAIST", "ì¹´ì´ìŠ¤íŠ¸", "UNIST", "ìœ ë‹ˆìŠ¤íŠ¸", "DGIST", "ë””ì§€ìŠ¤íŠ¸", "GIST", "ì§€ìŠ¤íŠ¸",
    "KENTECH", "ì¼„í…", "í•œêµ­ì—ë„ˆì§€ê³µëŒ€", "í•œêµ­ì—ë„ˆì§€ê³µê³¼ëŒ€í•™êµ"
  ].map(x=>normalizeUniv(x)));

  // 4) ì§‘ê³„ í•¨ìˆ˜
  const countByUniv = (rows) => {
    const m = new Map();
    rows.forEach(r=>{
      const u = normalizeUniv(r.univ);
      if (!u) return;
      m.set(u, (m.get(u)||0) + 1);
    });
    return Array.from(m.entries())
      .map(([univ, pass])=>({univ, pass}))
      .sort((a,b)=> b.pass - a.pass || a.univ.localeCompare(b.univ, "ko"));
  };

  // (A) íŠ¹ëª©ëŒ€ (ì–´ë”” ì§€ì—­ì´ë“ )
  const spRows = passRows.filter(r => SP_SET.has(normalizeUniv(r.univ)));

  // (B) ìˆ˜ë„ê¶Œ: region ìˆìœ¼ë©´ regionìœ¼ë¡œ, ì—†ìœ¼ë©´ â€œë³´ì •ëœ ëŒ€í•™ëª…â€ìœ¼ë¡œëŠ” íŒì •í•˜ì§€ ì•Šê³  ì œì™¸(ì›ì¹™: region ìµœìš°ì„ )
  const metroRows = passRows.filter(r => {
    const metro = isMetroByRegion(r.region);
    if (metro === null) return false; // region ì—†ìœ¼ë©´ ìˆ˜ë„ê¶Œ í‘œì—ì„œëŠ” ì œì™¸(ì›ì¹™)
    return metro;
  });

  return {
    metroPassByUniv: countByUniv(metroRows),
    spUnivPassByUniv: countByUniv(spRows),
  };
}

  </script>
</body>
</html>
